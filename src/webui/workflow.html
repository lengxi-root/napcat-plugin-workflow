<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯è§†åŒ–å·¥ä½œæµ</title>
  <style>
    /* bootstrap-icons font + used icons */
    @font-face {
      font-display: block;
      font-family: "bootstrap-icons";
      src: url("../api/fonts/bootstrap-icons.woff2") format("woff2"), url("../api/fonts/bootstrap-icons.woff") format("woff")
    }

    .bi::before,
    [class^="bi-"]::before,
    [class*=" bi-"]::before {
      display: inline-block;
      font-family: bootstrap-icons !important;
      font-style: normal;
      font-weight: normal !important;
      font-variant: normal;
      text-transform: none;
      line-height: 1;
      vertical-align: -.125em;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale
    }

    .bi-arrow-right::before {
      content: "\f138"
    }

    .bi-at::before {
      content: "\f152"
    }

    .bi-braces::before {
      content: "\f1c9"
    }

    .bi-calendar::before {
      content: "\f1f6"
    }

    .bi-chat-dots::before {
      content: "\f24a"
    }

    .bi-chat-quote::before {
      content: "\f255"
    }

    .bi-check-lg::before {
      content: "\f633"
    }

    .bi-chevron-down::before {
      content: "\f282"
    }

    .bi-chevron-up::before {
      content: "\f286"
    }

    .bi-clock::before {
      content: "\f293"
    }

    .bi-database::before {
      content: "\f8c4"
    }

    .bi-diagram-3::before {
      content: "\f2ee"
    }

    .bi-download::before {
      content: "\f30a"
    }

    .bi-eye::before {
      content: "\f341"
    }

    .bi-eye-slash::before {
      content: "\f340"
    }

    .bi-gear::before {
      content: "\f3e5"
    }

    .bi-globe::before {
      content: "\f3ee"
    }

    .bi-grip-vertical::before {
      content: "\f3fe"
    }

    .bi-info-circle::before {
      content: "\f431"
    }

    .bi-lightning::before {
      content: "\f46f"
    }

    .bi-pencil::before {
      content: "\f4cb"
    }

    .bi-pencil-square::before {
      content: "\f4ca"
    }

    .bi-person::before {
      content: "\f4e1"
    }

    .bi-play-circle::before {
      content: "\f4f3"
    }

    .bi-plus::before {
      content: "\f4fe"
    }

    .bi-plus-lg::before {
      content: "\f64d"
    }

    .bi-question-circle::before {
      content: "\f505"
    }

    .bi-shield-lock::before {
      content: "\f538"
    }

    .bi-shuffle::before {
      content: "\f544"
    }

    .bi-signpost-split::before {
      content: "\f549"
    }

    .bi-stars::before {
      content: "\f589"
    }

    .bi-three-dots-vertical::before {
      content: "\f5d3"
    }

    .bi-trash::before {
      content: "\f5de"
    }

    .bi-trophy::before {
      content: "\f5e7"
    }

    .bi-upload::before {
      content: "\f603"
    }

    .bi-x-lg::before {
      content: "\f659"
    }
  </style>
  <style>
    :root {
      --bg-primary: rgba(255, 255, 255, 0.4);
      --bg-secondary: rgba(255, 255, 255, 0.6);
      --bg-card: rgba(255, 255, 255, 0.5);
      --bg-item: rgba(0, 0, 0, 0.03);
      --text-primary: #1a1a1a;
      --text-secondary: #666;
      --text-muted: #999;
      --border-color: rgba(0, 0, 0, 0.08);
      --accent-color: #5865F2;
      --accent-light: rgba(88, 101, 242, 0.1);
      --success-color: #17c964;
      --warning-color: #f5a623;
      --danger-color: #f31260;
      --canvas-dot: #e2e8f0;
    }

    /* æ·±è‰²æ¨¡å¼ - ä½¿ç”¨ class æ–¹å¼ä¸ napcat ä¸»ä½“è”åŠ¨ */
    html.dark {
      --bg-primary: #1e1f22;
      --bg-secondary: #1a1b1e;
      --bg-card: #202124;
      --bg-item: #2a2b2e;
      --text-primary: #f5f5f5;
      --text-secondary: #a1a1a1;
      --text-muted: #666;
      --border-color: #333538;
      --accent-light: rgba(88, 101, 242, 0.2);
      --canvas-dot: #374151;
      background-color: #18191C;
      color-scheme: dark;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      min-height: 100vh;
      padding: 12px;
      color: var(--text-primary);
    }

    /* å¤´éƒ¨ */
    .header {
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 42px;
      height: 42px;
      background: var(--accent-light);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--accent-color);
    }

    .header-title h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .header-title p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      padding: 8px 14px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-item);
      color: var(--text-primary);
    }

    .btn:hover {
      background: var(--accent-light);
      border-color: var(--accent-color);
    }

    .btn-primary {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
      border-color: var(--success-color);
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 11px;
    }

    /* ä¸»å¸ƒå±€ */
    .main-layout {
      display: flex;
      gap: 12px;
      height: calc(100vh - 110px);
      min-height: 500px;
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 240px;
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 14px;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0;
    }

    .sidebar-section {
      padding: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-section:last-child {
      border-bottom: none;
      flex: 1;
      overflow-y: auto;
    }

    .sidebar-title {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    /* èŠ‚ç‚¹è°ƒè‰²æ¿ */
    .node-item {
      padding: 10px 12px;
      margin-bottom: 6px;
      background: var(--bg-item);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
      font-size: 12px;
    }

    .node-item:hover {
      border-color: var(--accent-color);
      background: var(--accent-light);
    }

    .node-item i {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }

    .node-item.trigger i {
      color: var(--success-color);
    }

    .node-item.condition i {
      color: var(--warning-color);
    }

    .node-item.action i {
      color: var(--accent-color);
    }

    /* å·¥ä½œæµåˆ—è¡¨ */
    .wf-item {
      padding: 10px 12px;
      background: var(--bg-item);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .wf-item:hover {
      border-color: var(--accent-color);
    }

    .wf-item.active {
      border-color: var(--accent-color);
      background: var(--accent-light);
      border-left: 3px solid var(--accent-color);
    }

    .wf-item .wf-name {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 3px;
    }

    .wf-item .wf-trigger {
      font-size: 10px;
      color: var(--text-muted);
    }

    .wf-item .wf-actions {
      margin-top: 6px;
      display: flex;
      gap: 4px;
    }

    .wf-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 9px;
    }

    .wf-badge.on {
      background: rgba(23, 201, 100, 0.15);
      color: var(--success-color);
    }

    .wf-badge.off {
      background: rgba(243, 18, 96, 0.15);
      color: var(--danger-color);
    }

    /* ç”»å¸ƒ */
    .canvas-container {
      flex: 1;
      background: var(--bg-card);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 14px;
      border: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    .canvas-inner {
      width: 4000px;
      height: 3000px;
      position: relative;
      background-image: radial-gradient(circle, var(--canvas-dot) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* å·¥ä½œæµèŠ‚ç‚¹ */
    .wf-node {
      position: absolute;
      min-width: 160px;
      background: var(--bg-card);
      backdrop-filter: blur(8px);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      cursor: move;
      z-index: 10;
    }

    .wf-node.selected {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .wf-node.trigger {
      border-color: var(--success-color);
    }

    .wf-node.condition {
      border-color: var(--warning-color);
    }

    .wf-node.action {
      border-color: var(--accent-color);
    }

    .wf-node.storage,
    .wf-node.global_storage {
      border-color: var(--danger-color);
    }

    .wf-node.delay {
      border-color: var(--text-muted);
    }

    .node-header {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
      font-size: 11px;
    }

    .node-body {
      padding: 8px 10px;
      font-size: 10px;
      color: var(--text-secondary);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .node-port {
      width: 16px;
      height: 16px;
      background: var(--bg-card);
      border: 3px solid var(--text-muted);
      border-radius: 50%;
      position: absolute;
      cursor: pointer;
      z-index: 100;
      transition: all 0.15s;
    }

    .node-port.input {
      top: 50%;
      left: -8px;
      transform: translateY(-50%);
    }

    .node-port.output {
      top: 50%;
      right: -8px;
      transform: translateY(-50%);
    }

    .node-port.output-1 {
      top: 35%;
      right: -8px;
      transform: translateY(-50%);
    }

    .node-port.output-2 {
      top: 65%;
      right: -8px;
      transform: translateY(-50%);
      border-color: var(--danger-color);
    }

    .node-port:hover {
      background: var(--accent-color);
      border-color: var(--accent-color);
      transform: translateY(-50%) scale(1.3);
    }

    .node-port.waiting {
      background: var(--success-color);
      border-color: var(--success-color);
      animation: pulse 0.8s infinite;
      transform: translateY(-50%) scale(1.2);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .btn-del-node {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--danger-color);
      color: #fff;
      border: none;
      font-size: 10px;
      cursor: pointer;
      display: none;
      z-index: 30;
    }

    .wf-node:hover .btn-del-node {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .connection-line {
      stroke: var(--text-muted);
      stroke-width: 2;
      fill: none;
    }

    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-box {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid var(--border-color);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-box.lg {
      max-width: 700px;
    }

    /* æ¨¡æ€æ¡†æ·±è‰²æ¨¡å¼ */
    html.dark .modal-box {
      background: #1f1f1f;
    }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h5 {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: 60vh;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* è¡¨å• */
    .form-group {
      margin-bottom: 12px;
    }

    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .form-control {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
      background: var(--bg-item);
      color: var(--text-primary);
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    select.form-control {
      cursor: pointer;
    }

    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }

    /* è¡¨æ ¼ */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .table th,
    .table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    .table th {
      font-weight: 600;
      color: var(--text-muted);
      font-size: 10px;
      text-transform: uppercase;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: rgba(23, 201, 100, 0.9);
      color: white;
    }

    .toast.error {
      background: rgba(243, 18, 96, 0.9);
      color: white;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* AI è¾“å…¥æ¡† */
    .ai-input-wrap {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .ai-input-wrap input {
      flex: 1;
    }


    /* ç”»å¸ƒå ä½æç¤º */
    .canvas-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      backdrop-filter: blur(8px);
    }

    .canvas-placeholder.hidden {
      display: none;
    }

    .canvas-placeholder-icon {
      font-size: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .canvas-placeholder-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .canvas-placeholder-hint {
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <div class="header-left">
      <div class="header-icon"><i class="bi bi-diagram-3"></i></div>
      <div class="header-title">
        <h4>å¯è§†åŒ–å·¥ä½œæµ</h4>
        <p>æ‹–æ‹½èŠ‚ç‚¹åˆ›å»ºè‡ªåŠ¨åŒ–æµç¨‹</p>
      </div>
    </div>
    <div class="header-center" style="flex:1;display:flex;align-items:center;justify-content:center;gap:8px">
      <i class="bi bi-pencil" style="color:var(--text-muted)"></i>
      <input type="text" id="workflowNameInput" class="form-control"
        style="max-width:200px;text-align:center;font-weight:600" placeholder="å·¥ä½œæµåç§°" onchange="updateWorkflowName()">
    </div>
    <div class="header-actions">
      <button class="btn" onclick="showAiGenerate()"><i class="bi bi-stars"></i> AIç”Ÿæˆ</button>
      <button class="btn" onclick="showScheduledTasks()"><i class="bi bi-clock"></i> å®šæ—¶ä»»åŠ¡</button>
      <button class="btn" onclick="exportAllWorkflows()" title="å¯¼å‡ºå…¨éƒ¨å·¥ä½œæµ"><i class="bi bi-download"></i> å¯¼å‡º</button>
      <button class="btn" onclick="importWorkflows()" title="å¯¼å…¥å·¥ä½œæµ"><i class="bi bi-upload"></i> å¯¼å…¥</button>
      <button class="btn" onclick="newWorkflow()"><i class="bi bi-plus-lg"></i> æ–°å»º</button>
      <button class="btn btn-primary" onclick="saveWorkflow()"><i class="bi bi-check-lg"></i> ä¿å­˜</button>
    </div>
  </div>

  <!-- ä¸»å¸ƒå±€ -->
  <div class="main-layout">
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">èŠ‚ç‚¹ç±»å‹</div>
        <div class="node-item trigger" draggable="true" data-type="trigger"><i class="bi bi-lightning"></i> è§¦å‘å™¨</div>
        <div class="node-item condition" draggable="true" data-type="condition"><i class="bi bi-signpost-split"></i> æ¡ä»¶
        </div>
        <div class="node-item action" draggable="true" data-type="action"><i class="bi bi-play-circle"></i> åŠ¨ä½œ</div>
        <div class="node-item" draggable="true" data-type="storage"><i class="bi bi-database"></i> ç”¨æˆ·å­˜å‚¨</div>
        <div class="node-item" draggable="true" data-type="global_storage"><i class="bi bi-globe"></i> å…¨å±€å­˜å‚¨</div>
        <div class="node-item" draggable="true" data-type="leaderboard"><i class="bi bi-trophy"></i> æ’è¡Œæ¦œ</div>
        <div class="node-item" draggable="true" data-type="delay"><i class="bi bi-clock"></i> å»¶æ—¶</div>
        <div class="node-item" draggable="true" data-type="set_var"><i class="bi bi-braces"></i> è®¾ç½®å˜é‡</div>
        <div class="node-item" draggable="true" data-type="list_random"><i class="bi bi-shuffle"></i> éšæœºæŠ½å–</div>
        <div class="node-item" draggable="true" data-type="comment"><i class="bi bi-chat-quote"></i> æ³¨é‡Š</div>
      </div>
      <div class="sidebar-section">
        <div class="sidebar-title">å·¥ä½œæµåˆ—è¡¨</div>
        <div id="workflowList"></div>
      </div>
    </div>

    <!-- ç”»å¸ƒ -->
    <div class="canvas-container" id="canvasContainer">
      <div class="canvas-placeholder" id="canvasPlaceholder">
        <i class="bi bi-diagram-3 canvas-placeholder-icon"></i>
        <div class="canvas-placeholder-text">è¯·ç‚¹å‡»ã€Œæ–°å»ºã€æ¥æ¿€æ´»ç”»æ¿</div>
        <div class="canvas-placeholder-hint">æˆ–ä»å·¦ä¾§å·¥ä½œæµåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå·²æœ‰å·¥ä½œæµ</div>
      </div>
      <div class="canvas-inner" id="canvasInner">
        <svg id="connectionsSvg"
          style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;"></svg>
      </div>
    </div>
  </div>

  <!-- èŠ‚ç‚¹ç¼–è¾‘æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="nodeModal">
    <div class="modal-box">
      <div class="modal-header">
        <h5 id="nodeModalTitle">ç¼–è¾‘èŠ‚ç‚¹</h5>
        <button class="modal-close" onclick="closeModal('nodeModal')">&times;</button>
      </div>
      <div class="modal-body" id="nodeModalBody"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('nodeModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveNodeEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å®šæ—¶ä»»åŠ¡æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="scheduledModal">
    <div class="modal-box lg">
      <div class="modal-header">
        <h5><i class="bi bi-clock me-2"></i>å®šæ—¶ä»»åŠ¡ç®¡ç†</h5>
        <button class="modal-close" onclick="closeModal('scheduledModal')">&times;</button>
      </div>
      <div class="modal-body">
        <button class="btn btn-sm btn-primary" onclick="showAddTaskForm()" style="margin-bottom:12px"><i
            class="bi bi-plus"></i> æ·»åŠ ä»»åŠ¡</button>
        <div id="addTaskForm"
          style="display:none;background:var(--bg-item);padding:12px;border-radius:8px;margin-bottom:12px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div class="form-group"><label class="form-label">ä»»åŠ¡ID</label><input type="text" class="form-control"
                id="taskId" placeholder="å”¯ä¸€æ ‡è¯†"></div>
            <div class="form-group"><label class="form-label">ç»‘å®šå·¥ä½œæµ</label><select class="form-control"
                id="taskWorkflowId"></select></div>
            <div class="form-group"><label class="form-label">ä»»åŠ¡ç±»å‹</label><select class="form-control" id="taskType"
                onchange="updateTaskTypeFields()">
                <option value="daily">æ¯æ—¥å®šæ—¶</option>
                <option value="interval">é—´éš”æ‰§è¡Œ</option>
              </select></div>
            <div class="form-group" id="dailyTimeGroup"><label class="form-label">æ‰§è¡Œæ—¶é—´</label><input type="time"
                class="form-control" id="taskDailyTime" value="08:00"></div>
            <div class="form-group" id="intervalGroup" style="display:none"><label
                class="form-label">é—´éš”(ç§’)</label><input type="number" class="form-control" id="taskInterval" value="3600"
                min="60"></div>
            <div class="form-group"><label class="form-label">ç›®æ ‡ç±»å‹</label><select class="form-control"
                id="taskTargetType">
                <option value="group">ç¾¤èŠ</option>
                <option value="private">ç§èŠ</option>
              </select></div>
            <div class="form-group"><label class="form-label">ç›®æ ‡ID</label><input type="text" class="form-control"
                id="taskTargetId" placeholder="ç¾¤å·æˆ–QQå·"></div>
            <div class="form-group"><label class="form-label">è™šæ‹Ÿè§¦å‘è€…</label><input type="text" class="form-control"
                id="taskTriggerUserId" placeholder="ç”¨äºæ¡ä»¶åˆ¤æ–­çš„QQå·ï¼ˆå¯é€‰ï¼‰"></div>
            <div class="form-group"><label class="form-label">å¤‡æ³¨</label><input type="text" class="form-control"
                id="taskDesc" placeholder="å¯é€‰"></div>
          </div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-sm btn-success" onclick="addScheduledTask()">æ·»åŠ </button>
            <button class="btn btn-sm" onclick="hideAddTaskForm()">å–æ¶ˆ</button>
          </div>
        </div>
        <div id="scheduledTaskList"></div>
      </div>
    </div>
  </div>

  <!-- ç¡®è®¤å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="confirmModal">
    <div class="modal-box" style="max-width:350px">
      <div class="modal-header">
        <h5 id="confirmModalTitle"><i class="bi bi-question-circle"></i> ç¡®è®¤æ“ä½œ</h5>
        <button class="modal-close" onclick="closeConfirmModal(false)">&times;</button>
      </div>
      <div class="modal-body">
        <p id="confirmModalMessage" style="font-size:13px">ç¡®å®šæ‰§è¡Œæ­¤æ“ä½œï¼Ÿ</p>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeConfirmModal(false)">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="closeConfirmModal(true)">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- ä¸»äººéªŒè¯æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="masterAuthModal">
    <div class="modal-box" style="max-width:350px">
      <div class="modal-header">
        <h5><i class="bi bi-shield-lock"></i> æƒé™éªŒè¯</h5>
        <button class="modal-close" onclick="closeModal('masterAuthModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">æ­¤åŠŸèƒ½éœ€è¦ä¸»äººæƒé™ï¼Œè¯·è¾“å…¥éªŒè¯å¯†ç </p>
        <div class="form-group">
          <label class="form-label">ä¸»äººå¯†ç </label>
          <input type="password" class="form-control" id="masterPassword" placeholder="è¯·è¾“å…¥ä¸»äººå¯†ç ">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('masterAuthModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="verifyMasterPassword()">éªŒè¯</button>
      </div>
    </div>
  </div>

  <!-- AIç”Ÿæˆæ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="aiModal">
    <div class="modal-box lg">
      <div class="modal-header">
        <h5><i class="bi bi-stars"></i> AI ç”Ÿæˆå·¥ä½œæµ</h5>
        <button class="modal-close" onclick="closeModal('aiModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æè¿°ä½ æƒ³è¦çš„å·¥ä½œæµåŠŸèƒ½</label>
          <textarea class="form-control" id="aiDescription" rows="4"
            placeholder="ä¾‹å¦‚ï¼šå½“ç”¨æˆ·å‘é€ã€Œç­¾åˆ°ã€æ—¶ï¼Œåˆ¤æ–­ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°ï¼Œæœªç­¾åˆ°åˆ™éšæœºè·å¾—5-10ç§¯åˆ†ï¼Œå·²ç­¾åˆ°åˆ™æç¤ºæ˜å¤©å†æ¥"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">AIæ¨¡å‹</label>
          <select class="form-control" id="aiModel">
            <optgroup label="ä¸»æ¥å£ (type=1)">
              <option value="auto" selected>ğŸ”„ è‡ªåŠ¨åˆ‡æ¢ (æ¨è)</option>
              <option value="gpt-5">GPT-5</option>
              <option value="gpt-5.1">GPT-5.1</option>
              <option value="gpt-5-mini">GPT-5 Mini</option>
              <option value="gpt-5-nano">GPT-5 Nano</option>
              <option value="gpt-4o">GPT-4o</option>
              <option value="gpt-4o-mini">GPT-4o Mini</option>
              <option value="gpt-4">GPT-4</option>
              <option value="gpt-4-turbo">GPT-4 Turbo</option>
              <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
              <option value="claude-3-5-haiku">Claude 3.5 Haiku</option>
              <option value="deepseek-chat">DeepSeek Chat</option>
              <option value="deepseek-reasoner">DeepSeek Reasoner</option>
              <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
            </optgroup>
          </select>
        </div>
        <div id="aiResult"
          style="display:none;margin-top:12px;padding:12px;background:var(--bg-item);border-radius:8px"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('aiModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="aiGenerateBtn" onclick="generateWorkflowByAi()"><i class="bi bi-stars"></i>
          ç”Ÿæˆ</button>
      </div>
    </div>
  </div>

  <!-- å›å¤å˜é‡å¸®åŠ©å¼¹çª— -->
  <div class="modal-overlay" id="replyHelpModal">
    <div class="modal-box lg" style="display:flex;flex-direction:column;max-height:85vh">
      <div class="modal-header" style="flex-shrink:0">
        <h5><i class="bi bi-info-circle"></i> å›å¤å†…å®¹æ”¯æŒçš„å˜é‡</h5>
        <button class="modal-close" onclick="closeModal('replyHelpModal')">&times;</button>
      </div>
      <div class="modal-body" style="flex:1;overflow-y:auto;min-height:0">
        <div style="font-size:12px">
          <!-- è‰¾ç‰¹ç›¸å…³ -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:var(--accent-color);margin-bottom:8px;font-size:13px"><i
                class="bi bi-at"></i> è‰¾ç‰¹åŠŸèƒ½</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>{at_user}</code></td>
                <td>è‰¾ç‰¹å‘é€æ¶ˆæ¯çš„ç”¨æˆ·</td>
              </tr>
              <tr>
                <td><code>[CQ:at,qq=123456]</code></td>
                <td>è‰¾ç‰¹æŒ‡å®šQQå·çš„ç”¨æˆ·ï¼ˆæ›¿æ¢123456ä¸ºQQå·ï¼‰</td>
              </tr>
              <tr>
                <td><code>[CQ:at,qq=all]</code></td>
                <td>è‰¾ç‰¹å…¨ä½“æˆå‘˜ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</td>
              </tr>
              <tr>
                <td><code>[CQ:at,qq={user_id}]</code></td>
                <td>è‰¾ç‰¹å‘é€è€…ï¼ˆç­‰åŒäº {at_user}ï¼‰</td>
              </tr>
            </table>
          </div>
          <!-- ç”¨æˆ·ä¿¡æ¯ -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:var(--success-color);margin-bottom:8px;font-size:13px"><i
                class="bi bi-person"></i> ç”¨æˆ·ä¸ç¾¤ä¿¡æ¯</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>{user_id}</code></td>
                <td>å‘é€è€…çš„QQå·</td>
              </tr>
              <tr>
                <td><code>{group_id}</code></td>
                <td>å½“å‰ç¾¤å·ï¼ˆç§èŠä¸ºç©ºï¼‰</td>
              </tr>
              <tr>
                <td><code>{message_id}</code></td>
                <td>æ¶ˆæ¯IDï¼ˆç”¨äºæ’¤å›ç­‰æ“ä½œï¼‰</td>
              </tr>
              <tr>
                <td><code>{content}</code></td>
                <td>ç”¨æˆ·å‘é€çš„æ¶ˆæ¯å†…å®¹</td>
              </tr>
              <tr>
                <td><code>{message}</code></td>
                <td>åŒ {content}</td>
              </tr>
            </table>
          </div>
          <!-- æ—¥æœŸæ—¶é—´ -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:var(--warning-color);margin-bottom:8px;font-size:13px"><i
                class="bi bi-calendar"></i> æ—¥æœŸä¸æ—¶é—´</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>{today}</code> / <code>{date}</code></td>
                <td>å½“å‰æ—¥æœŸ (YYYY-MM-DD)</td>
              </tr>
              <tr>
                <td><code>{time}</code></td>
                <td>å½“å‰æ—¶é—´ (HH:MM:SS)</td>
              </tr>
              <tr>
                <td><code>{datetime}</code></td>
                <td>æ—¥æœŸæ—¶é—´ (YYYY-MM-DD HH:MM:SS)</td>
              </tr>
              <tr>
                <td><code>{timestamp}</code></td>
                <td>Unixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰</td>
              </tr>
              <tr>
                <td><code>{year}</code></td>
                <td>å¹´ä»½</td>
              </tr>
              <tr>
                <td><code>{month}</code></td>
                <td>æœˆä»½ (1-12)</td>
              </tr>
              <tr>
                <td><code>{day}</code></td>
                <td>æ—¥æœŸ (1-31)</td>
              </tr>
              <tr>
                <td><code>{hour}</code></td>
                <td>å°æ—¶ (0-23)</td>
              </tr>
              <tr>
                <td><code>{minute}</code></td>
                <td>åˆ†é’Ÿ (0-59)</td>
              </tr>
              <tr>
                <td><code>{weekday}</code></td>
                <td>æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1-6)</td>
              </tr>
              <tr>
                <td><code>{weekday_cn}</code></td>
                <td>æ˜ŸæœŸå‡ ä¸­æ–‡ (å‘¨æ—¥~å‘¨å…­)</td>
              </tr>
            </table>
          </div>
          <!-- éšæœºæ•° -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:var(--danger-color);margin-bottom:8px;font-size:13px"><i
                class="bi bi-shuffle"></i> éšæœºæ•°</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>{random}</code> / <code>{random100}</code></td>
                <td>1-100 éšæœºæ•´æ•°</td>
              </tr>
              <tr>
                <td><code>{random10}</code></td>
                <td>1-10 éšæœºæ•´æ•°</td>
              </tr>
              <tr>
                <td><code>{random6}</code></td>
                <td>1-6 éšæœºæ•´æ•°ï¼ˆéª°å­ï¼‰</td>
              </tr>
            </table>
          </div>
          <!-- æ­£åˆ™ä¸å­˜å‚¨ -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:var(--text-secondary);margin-bottom:8px;font-size:13px"><i
                class="bi bi-braces"></i> æ­£åˆ™åŒ¹é…ä¸å­˜å‚¨</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>{$1}</code> <code>{$2}</code> ...</td>
                <td>æ­£åˆ™åŒ¹é…çš„æ•è·ç»„ï¼ˆè§¦å‘å™¨ä¸ºæ­£åˆ™æ—¶å¯ç”¨ï¼‰</td>
              </tr>
              <tr>
                <td><code>{storage.é”®å}</code></td>
                <td>è¯»å–ç”¨æˆ·å­˜å‚¨çš„å€¼ï¼Œå¦‚ {storage.score}</td>
              </tr>
              <tr>
                <td><code>{è‡ªå®šä¹‰å˜é‡}</code></td>
                <td>å¼•ç”¨ä¹‹å‰è®¾ç½®çš„å˜é‡ï¼ˆset_var æˆ–è¿ç®—ç»“æœï¼‰</td>
              </tr>
              <tr>
                <td><code>{math_result}</code></td>
                <td>æ•°å­¦è¿ç®—çš„ç»“æœ</td>
              </tr>
              <tr>
                <td><code>{string_result}</code></td>
                <td>å­—ç¬¦ä¸²æ“ä½œçš„ç»“æœ</td>
              </tr>
              <tr>
                <td><code>{leaderboard}</code></td>
                <td>æ’è¡Œæ¦œæ–‡æœ¬ï¼ˆä½¿ç”¨æ’è¡Œæ¦œèŠ‚ç‚¹åï¼‰</td>
              </tr>
              <tr>
                <td><code>{my_rank}</code></td>
                <td>æˆ‘çš„æ’åï¼ˆä½¿ç”¨æ’è¡Œæ¦œèŠ‚ç‚¹åï¼‰</td>
              </tr>
            </table>
          </div>
          <!-- ç‰¹æ®Šæ¶ˆæ¯æ ¼å¼ -->
          <div style="margin-bottom:16px">
            <div style="font-weight:600;color:#9b59b6;margin-bottom:8px;font-size:13px"><i class="bi bi-chat-dots"></i>
              ç‰¹æ®Šæ¶ˆæ¯æ ¼å¼ (CQç )</div>
            <table class="table">
              <tr>
                <td style="width:180px"><code>[CQ:face,id=178]</code></td>
                <td>å‘é€QQè¡¨æƒ…ï¼ˆ178ä¸ºè¡¨æƒ…IDï¼‰</td>
              </tr>
              <tr>
                <td><code>[CQ:image,file=URL]</code></td>
                <td>å‘é€å›¾ç‰‡</td>
              </tr>
              <tr>
                <td><code>[CQ:record,file=URL]</code></td>
                <td>å‘é€è¯­éŸ³</td>
              </tr>
              <tr>
                <td><code>[CQ:reply,id=xxx]</code></td>
                <td>å¼•ç”¨å›å¤æŒ‡å®šæ¶ˆæ¯</td>
              </tr>
            </table>
          </div>
          <!-- éšæœºå›å¤ -->
          <div style="margin-bottom:8px">
            <div style="font-weight:600;color:#16a085;margin-bottom:8px;font-size:13px"><i class="bi bi-shuffle"></i>
              å¤šæ¡éšæœºå›å¤</div>
            <div style="background:var(--bg-item);padding:10px;border-radius:6px;font-size:11px">
              ä½¿ç”¨ <code>|||</code> åˆ†éš”å¤šæ¡å›å¤ï¼Œç³»ç»Ÿä¼šéšæœºé€‰æ‹©ä¸€æ¡å‘é€ï¼š<br>
              <code style="color:var(--accent-color)">æ—©ä¸Šå¥½ï¼|||ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡å“¦|||ç¾å¥½çš„ä¸€å¤©å¼€å§‹äº†</code>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="flex-shrink:0">
        <button class="btn btn-primary" onclick="closeModal('replyHelpModal')">çŸ¥é“äº†</button>
      </div>
    </div>
  </div>

  <script>
    // Dark Mode Logic - Follow System
    function updateTheme () {
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }

    // åˆå§‹åŒ–ä¸»é¢˜å¹¶ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
    updateTheme();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);

    // API è·¯ç”±åœ¨ /plugin/{pluginId}/api/ ä¸‹ï¼Œé¡µé¢è·¯ç”±åœ¨ /plugin/{pluginId}/page/ ä¸‹
    const API_BASE = window.location.pathname.replace('/page/', '/api/').replace(/\/[^\/]*$/, '');
    const AI_API = 'https://i.elaina.vin/api/openai/v1/chat/completions';

    // æ¨¡å‹åˆ—è¡¨ï¼ˆå¯ä» API åŠ¨æ€è·å–ï¼‰
    let ALL_MODELS = ['gpt-5', 'gpt-5-mini', 'gpt-5-nano', 'gpt-5.1', 'gpt-4o', 'gpt-4o-mini', 'gpt-4', 'gpt-4-turbo', 'claude-3-5-sonnet', 'claude-3-5-haiku', 'deepseek-chat', 'deepseek-reasoner', 'gemini-2.5-flash', 'gemini-2.5-pro'];
    // type=100 è¡¨ç¤ºè‡ªåŠ¨åˆ‡æ¢æ¨¡å¼ï¼Œtype=1 è¡¨ç¤ºæ™®é€šæ¨¡å¼
    const getApiType = (model) => model === 'auto' ? 100 : 1;

    // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å¯ç”¨ï¼Œä¸å¯ç”¨åˆ™è‡ªåŠ¨åˆ‡æ¢ä¸º auto
    function validateModel (model) {
      if (model === 'auto' || ALL_MODELS.includes(model)) return model;
      showToast(`æ¨¡å‹ "${model}" å·²ä¸å¯ç”¨ï¼Œå·²åˆ‡æ¢ä¸ºè‡ªåŠ¨åˆ‡æ¢æ¨¡å¼`, 'warning');
      return 'auto';
    }

    // ä» API è·å–æ¨¡å‹åˆ—è¡¨
    async function refreshModelList () {
      try {
        const res = await fetch('https://i.elaina.vin/api/openai/models', { signal: AbortSignal.timeout(5000) });
        if (res.ok) {
          const data = await res.json();
          if (data.success && data.chat?.length) {
            ALL_MODELS = data.chat;
            updateModelSelect();
            return true;
          }
        }
      } catch { /* ignore */ }
      return false;
    }

    // æ›´æ–°æ¨¡å‹ä¸‹æ‹‰æ¡†
    function updateModelSelect () {
      const select = document.getElementById('aiModel');
      if (!select) return;
      const currentValue = select.value;
      const optgroup = select.querySelector('optgroup');
      if (optgroup) {
        optgroup.innerHTML = '<option value="auto" selected>ğŸ”„ è‡ªåŠ¨åˆ‡æ¢ (æ¨è)</option>' + ALL_MODELS.map(m => `<option value="${m}">${m}</option>`).join('');
        // å¦‚æœå½“å‰é€‰æ‹©çš„æ¨¡å‹ä¸å¯ç”¨ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸º auto
        select.value = validateModel(currentValue);
      }
    }

    // åˆå§‹åŒ–æ—¶è·å–æ¨¡å‹åˆ—è¡¨
    refreshModelList();

    // è·å–è®¤è¯ token
    const urlParams = new URLSearchParams(window.location.search);
    const webuiToken = urlParams.get('webui_token')?.replace(/^"|"$/g, '') || '';

    // å¸¦è®¤è¯çš„ fetch
    async function authFetch (url, options = {}) {
      const headers = { ...options.headers };
      if (webuiToken) headers['Authorization'] = `Bearer ${webuiToken}`;
      if (options.body && typeof options.body === 'string') headers['Content-Type'] = 'application/json';
      return fetch(url, { ...options, headers });
    }

    // ä¸»äººæƒé™ç›¸å…³
    let requireMaster = false;
    let masterPassword = '';
    let masterOnlyTriggers = ['regex', 'any', 'scheduled', 'timer'];
    let pendingMasterAction = null;

    async function loadConfig () {
      try {
        const res = await authFetch(API_BASE + '/config');
        const data = await res.json();
        if (data.success) {
          requireMaster = data.require_master;
          masterOnlyTriggers = data.master_only_triggers || masterOnlyTriggers;
        }
      } catch (e) { }
    }

    function needsMasterAuth (triggerType) {
      return requireMaster && masterOnlyTriggers.includes(triggerType) && !masterPassword;
    }

    function showMasterAuth (callback) {
      pendingMasterAction = callback;
      document.getElementById('masterPassword').value = '';
      openModal('masterAuthModal');
    }

    async function verifyMasterPassword () {
      const pwd = document.getElementById('masterPassword').value;
      try {
        const res = await authFetch(API_BASE + '/verify_master', { method: 'POST', body: JSON.stringify({ password: pwd }) });
        const data = await res.json();
        if (data.success) {
          masterPassword = pwd;
          closeModal('masterAuthModal');
          showToast('éªŒè¯æˆåŠŸ');
          if (pendingMasterAction) { pendingMasterAction(); pendingMasterAction = null; }
        } else { showToast(data.error || 'å¯†ç é”™è¯¯', 'error'); }
      } catch (e) { showToast('éªŒè¯å¤±è´¥', 'error'); }
    }

    // å¸¦ä¸»äººå¯†ç çš„è¯·æ±‚
    async function masterAuthFetch (url, options = {}) {
      let body = {};
      if (options.body) { try { body = JSON.parse(options.body); } catch { body = {}; } }
      body.master_password = masterPassword;
      return authFetch(url, { ...options, body: JSON.stringify(body) });
    }

    // å·¥ä½œæµç”Ÿæˆç³»ç»Ÿæç¤º
    const WORKFLOW_SYSTEM_PROMPT = `ä½ æ˜¯QQæœºå™¨äººå·¥ä½œæµç”Ÿæˆå™¨ã€‚æ ¹æ®ç”¨æˆ·éœ€æ±‚ç”Ÿæˆå®Œæ•´çš„å·¥ä½œæµJSONã€‚

## èŠ‚ç‚¹ç±»å‹
1. trigger - è§¦å‘å™¨(å¿…é¡»æœ‰ä¸€ä¸ª) data:{trigger_type:"exact/startswith/contains/regex/scheduled",trigger_content:"è§¦å‘è¯"}
2. condition - æ¡ä»¶åˆ¤æ–­(2è¾“å‡º:æ»¡è¶³output-1,ä¸æ»¡è¶³output-2) è§ä¸‹æ–¹æ¡ä»¶ç±»å‹
3. action - åŠ¨ä½œèŠ‚ç‚¹ è§ä¸‹æ–¹åŠ¨ä½œç±»å‹
4. storage - ç”¨æˆ·å­˜å‚¨ data:{storage_type:"get/set/incr/decr/delete",storage_key:"é”®",storage_value:"å€¼",default_value:"é»˜è®¤",result_var:"å˜é‡"}
5. global_storage - å…¨å±€å­˜å‚¨(åŒstorage)
6. leaderboard - æ’è¡Œæ¦œ data:{leaderboard_type:"top/my_rank/count",leaderboard_key:"score",limit:10,ascending:"false"}
7. delay - å»¶æ—¶ data:{seconds:3}
8. set_var - è®¾ç½®å˜é‡ data:{var_name:"å",var_value:"å€¼"}
9. list_random - éšæœºæŠ½å– data:{list_items:"a|b|c",weights:"50|30|20",result_var:"result",index_var:"index"}

## æ¡ä»¶ç±»å‹(conditionèŠ‚ç‚¹çš„dataå¿…é¡»åŒ…å«condition_type)
- contains: å†…å®¹åŒ…å« {condition_type:"contains",condition_value:"è¦åŒ…å«çš„æ–‡å­—"}
- equals: å†…å®¹ç­‰äº {condition_type:"equals",condition_value:"è¦ç­‰äºçš„æ–‡å­—"}
- regex: æ­£åˆ™åŒ¹é… {condition_type:"regex",condition_value:"æ­£åˆ™è¡¨è¾¾å¼"}
- random: éšæœºæ¦‚ç‡ {condition_type:"random",condition_value:"50"}  50è¡¨ç¤º50%æ¦‚ç‡
- user_id: ç”¨æˆ·ID {condition_type:"user_id",condition_value:"12345678"}
- group_id: ç¾¤ID {condition_type:"group_id",condition_value:"12345678"}
- var_equals: å˜é‡ç­‰äº {condition_type:"var_equals",var_name:"å˜é‡å",condition_value:"æœŸæœ›å€¼"}
- var_gt: å˜é‡å¤§äº {condition_type:"var_gt",var_name:"å˜é‡å",condition_value:"æ•°å€¼"}
- var_lt: å˜é‡å°äº {condition_type:"var_lt",var_name:"å˜é‡å",condition_value:"æ•°å€¼"}
- data_equals: å­˜å‚¨ç­‰äº {condition_type:"data_equals",condition_value:"score=100"} æ£€æŸ¥ç”¨æˆ·å­˜å‚¨
- data_gt: å­˜å‚¨å¤§äº {condition_type:"data_gt",condition_value:"score>50"}
- data_lt: å­˜å‚¨å°äº {condition_type:"data_lt",condition_value:"score<100"}
- data_is_today: ä»Šæ—¥å·²æ“ä½œ {condition_type:"data_is_today",condition_value:"sign_date"} å­˜å‚¨æ—¥æœŸçš„é”®å
- cooldown: å†·å´æ—¶é—´ {condition_type:"cooldown",condition_value:"last_use,60"} é”®å,ç§’æ•°
- time_range: æ—¶é—´èŒƒå›´ {condition_type:"time_range",condition_value:"9-18"} å°æ—¶èŒƒå›´
- weekday_in: æ˜ŸæœŸå‡  {condition_type:"weekday_in",condition_value:"å‘¨ä¸€|å‘¨äºŒ|å‘¨ä¸‰"} æˆ– "1|2|3"
- global_equals: å…¨å±€å­˜å‚¨ç­‰äº {condition_type:"global_equals",condition_value:"status=open"}
- global_gt: å…¨å±€å­˜å‚¨å¤§äº {condition_type:"global_gt",condition_value:"count>10"}
- expression: JSè¡¨è¾¾å¼ {condition_type:"expression",condition_value:"{score} > 50 && {level} >= 2"}

## åŠ¨ä½œç±»å‹(actionèŠ‚ç‚¹çš„dataå¿…é¡»åŒ…å«action_type)
- reply_text: å›å¤æ–‡å­— {action_type:"reply_text",action_value:"å†…å®¹ï¼Œç”¨|||åˆ†éš”å¤šæ¡éšæœº"}
- reply_image: å‘å›¾ç‰‡ {action_type:"reply_image",action_value:"å›¾ç‰‡URL",image_text:"è¯´æ˜"}
- reply_voice: å‘è¯­éŸ³ {action_type:"reply_voice",action_value:"è¯­éŸ³URL"}
- reply_video: å‘è§†é¢‘ {action_type:"reply_video",action_value:"è§†é¢‘URL"}
- reply_at: @å›å¤ {action_type:"reply_at",action_value:"å†…å®¹"}
- reply_face: è¡¨æƒ… {action_type:"reply_face",action_value:"è¡¨æƒ…ID"}
- reply_poke: æˆ³ä¸€æˆ³ {action_type:"reply_poke",action_value:"ç›®æ ‡QQ"}
- reply_forward: åˆå¹¶è½¬å‘ {action_type:"reply_forward",action_value:"æ¶ˆæ¯1|||æ¶ˆæ¯2|||æ¶ˆæ¯3"}
- reply_json: JSONå¡ç‰‡ {action_type:"reply_json",action_value:"JSONå­—ç¬¦ä¸²"}
- reply_file: å‘æ–‡ä»¶ {action_type:"reply_file",action_value:"æ–‡ä»¶URL",file_name:"æ–‡ä»¶å"}
- reply_music: éŸ³ä¹åˆ†äº« {action_type:"reply_music",music_type:"qq/163/custom",action_value:"æ­Œæ›²ID"}
- custom_api: è°ƒç”¨API {action_type:"custom_api",api_url:"URL",api_method:"GET/POST",api_headers:"è¯·æ±‚å¤´JSON",api_body:"è¯·æ±‚ä½“",response_type:"json/text",result_var:"api_result",api_reply:"å›å¤æ¨¡æ¿ç”¨{api_json.å­—æ®µ}"}
- math: æ•°å­¦è¿ç®— {action_type:"math",math_type:"add/sub/mul/div/mod/random",operand1:"æ•°å€¼1",operand2:"æ•°å€¼2",result_var:"math_result"}
- string_op: å­—ç¬¦ä¸² {action_type:"string_op",string_type:"concat/replace/split/substr/length/upper/lower",input1:"å­—ç¬¦ä¸²1",input2:"å­—ç¬¦ä¸²2",result_var:"string_result"}
- group_sign: ç¾¤ç­¾åˆ° {action_type:"group_sign"}
- group_ban: ç¾¤ç¦è¨€ {action_type:"group_ban",target_user:"{user_id}",ban_duration:"600"}
- group_kick: ç¾¤è¸¢äºº {action_type:"group_kick",target_user:"{user_id}",reject_add:"false"}
- group_whole_ban: å…¨å‘˜ç¦è¨€ {action_type:"group_whole_ban",enable_ban:"true/false"}
- group_set_card: è®¾ç½®ç¾¤åç‰‡ {action_type:"group_set_card",target_user:"{user_id}",card_value:"æ–°åç‰‡"}
- group_notice: å‘ç¾¤å…¬å‘Š {action_type:"group_notice",action_value:"å…¬å‘Šå†…å®¹"}
- recall_msg: æ’¤å›æ¶ˆæ¯ {action_type:"recall_msg",message_id:"{message_id}"}
- call_api: è°ƒç”¨NapCatAPI {action_type:"call_api",api_action:"send_group_sign",api_params:'{"group_id":"{group_id}"}',result_var:"result"}

## å˜é‡: {user_id} {group_id} {content} {$1} {$2} {today} {time} {timestamp} {random} {storage.é”®} {global.é”®} {math_result} {api_result} {api_json.å­—æ®µ}

## è¿æ¥: from_outputæ™®é€šèŠ‚ç‚¹ç”¨"output_1", conditionæ»¡è¶³ç”¨"output-1", ä¸æ»¡è¶³ç”¨"output-2"

## è¾“å‡ºæ ¼å¼(åªè¿”å›JSON):
{"name":"åç§°","nodes":[{"id":"node_1","type":"trigger","x":100,"y":150,"data":{...}},...],"connections":[{"from_node":"node_1","from_output":"output_1","to_node":"node_2"},...]}

## ç¤ºä¾‹:ç­¾åˆ°ç³»ç»Ÿ
{"name":"æ¯æ—¥ç­¾åˆ°","nodes":[{"id":"node_1","type":"trigger","x":100,"y":150,"data":{"trigger_type":"exact","trigger_content":"ç­¾åˆ°"}},{"id":"node_2","type":"condition","x":280,"y":150,"data":{"condition_type":"data_is_today","condition_value":"sign_date"}},{"id":"node_3","type":"action","x":460,"y":50,"data":{"action_type":"reply_text","action_value":"ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ˜å¤©å†æ¥~"}},{"id":"node_4","type":"action","x":460,"y":250,"data":{"action_type":"math","math_type":"random","operand1":"5","operand2":"10","result_var":"score"}},{"id":"node_5","type":"storage","x":640,"y":250,"data":{"storage_type":"incr","storage_key":"total_score","storage_value":"{score}"}},{"id":"node_6","type":"storage","x":820,"y":250,"data":{"storage_type":"set","storage_key":"sign_date","storage_value":"{today}"}},{"id":"node_7","type":"action","x":1000,"y":250,"data":{"action_type":"reply_text","action_value":"ç­¾åˆ°æˆåŠŸï¼+{score}åˆ†ï¼Œæ€»åˆ†{storage.total_score}"}}],"connections":[{"from_node":"node_1","from_output":"output_1","to_node":"node_2"},{"from_node":"node_2","from_output":"output-1","to_node":"node_3"},{"from_node":"node_2","from_output":"output-2","to_node":"node_4"},{"from_node":"node_4","from_output":"output_1","to_node":"node_5"},{"from_node":"node_5","from_output":"output_1","to_node":"node_6"},{"from_node":"node_6","from_output":"output_1","to_node":"node_7"}]}`;

    // èŠ‚ç‚¹é…ç½®
    const NODE_CONFIGS = {
      trigger: { title: 'è§¦å‘å™¨', icon: 'bi-lightning', color: 'success', inputs: 0, outputs: 1, isDynamic: true },
      condition: { title: 'æ¡ä»¶', icon: 'bi-signpost-split', color: 'warning', inputs: 1, outputs: 2, isDynamic: true },
      action: { title: 'åŠ¨ä½œ', icon: 'bi-play-circle', color: 'primary', inputs: 1, outputs: 1, isDynamic: true },
      storage: { title: 'ç”¨æˆ·å­˜å‚¨', icon: 'bi-database', color: 'danger', inputs: 1, outputs: 1, fields: [{ name: 'storage_type', label: 'æ“ä½œ', type: 'select', options: [{ value: 'get', label: 'è¯»å–' }, { value: 'set', label: 'å†™å…¥' }, { value: 'incr', label: 'å¢åŠ ' }, { value: 'decr', label: 'å‡å°‘' }, { value: 'delete', label: 'åˆ é™¤' }] }, { name: 'storage_key', label: 'é”®å', type: 'text' }, { name: 'storage_value', label: 'å€¼', type: 'text' }, { name: 'default_value', label: 'é»˜è®¤å€¼', type: 'text' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text' }] },
      global_storage: { title: 'å…¨å±€å­˜å‚¨', icon: 'bi-globe', color: 'primary', inputs: 1, outputs: 1, fields: [{ name: 'storage_type', label: 'æ“ä½œ', type: 'select', options: [{ value: 'get', label: 'è¯»å–' }, { value: 'set', label: 'å†™å…¥' }, { value: 'incr', label: 'å¢åŠ ' }, { value: 'decr', label: 'å‡å°‘' }] }, { name: 'storage_key', label: 'é”®å', type: 'text' }, { name: 'storage_value', label: 'å€¼', type: 'text' }, { name: 'default_value', label: 'é»˜è®¤å€¼', type: 'text' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text' }] },
      leaderboard: { title: 'æ’è¡Œæ¦œ', icon: 'bi-trophy', color: 'warning', inputs: 1, outputs: 1, fields: [{ name: 'leaderboard_type', label: 'æ“ä½œ', type: 'select', options: [{ value: 'top', label: 'è·å–æ’è¡Œæ¦œ' }, { value: 'my_rank', label: 'æˆ‘çš„æ’å' }, { value: 'count', label: 'ç»Ÿè®¡äººæ•°' }] }, { name: 'leaderboard_key', label: 'æ’è¡Œé”®å', type: 'text' }, { name: 'limit', label: 'TOPæ•°é‡', type: 'number' }, { name: 'ascending', label: 'æ’åº', type: 'select', options: [{ value: 'false', label: 'é™åº' }, { value: 'true', label: 'å‡åº' }] }] },
      delay: { title: 'å»¶æ—¶', icon: 'bi-clock', color: 'secondary', inputs: 1, outputs: 1, fields: [{ name: 'seconds', label: 'ç§’æ•°', type: 'number' }] },
      set_var: { title: 'è®¾ç½®å˜é‡', icon: 'bi-braces', color: 'info', inputs: 1, outputs: 1, fields: [{ name: 'var_name', label: 'å˜é‡å', type: 'text' }, { name: 'var_value', label: 'å˜é‡å€¼', type: 'text' }] },
      list_random: { title: 'éšæœºæŠ½å–', icon: 'bi-shuffle', color: 'info', inputs: 1, outputs: 1, fields: [{ name: 'list_items', label: 'é€‰é¡¹(|åˆ†éš”)', type: 'textarea' }, { name: 'weights', label: 'æƒé‡', type: 'text' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text' }] },
      comment: { title: 'æ³¨é‡Š', icon: 'bi-chat-quote', color: 'secondary', inputs: 0, outputs: 0, fields: [{ name: 'comment_text', label: 'å¤‡æ³¨', type: 'textarea' }] }
    };

    // è§¦å‘å™¨ç±»å‹é…ç½®
    const TRIGGER_TYPES = {
      exact: { label: 'å®Œå…¨åŒ¹é…', fields: [{ name: 'trigger_content', label: 'è§¦å‘è¯', type: 'text', placeholder: 'æ¶ˆæ¯å†…å®¹å®Œå…¨ç­‰äºæ­¤æ–‡å­—æ‰è§¦å‘' }] },
      startswith: { label: 'å‰ç¼€åŒ¹é…', fields: [{ name: 'trigger_content', label: 'è§¦å‘å‰ç¼€', type: 'text', placeholder: 'æ¶ˆæ¯ä»¥æ­¤æ–‡å­—å¼€å¤´æ‰è§¦å‘' }] },
      contains: { label: 'åŒ…å«åŒ¹é…', fields: [{ name: 'trigger_content', label: 'è§¦å‘å…³é”®è¯', type: 'text', placeholder: 'æ¶ˆæ¯åŒ…å«æ­¤æ–‡å­—æ‰è§¦å‘' }] },
      regex: { label: 'æ­£åˆ™åŒ¹é…', fields: [{ name: 'trigger_content', label: 'æ­£åˆ™è¡¨è¾¾å¼', type: 'text', placeholder: 'å¦‚ ^ç­¾åˆ°(.*)$ å¯ç”¨{$1}è·å–æ•è·ç»„' }] },
      scheduled: { label: 'å®šæ—¶è§¦å‘', fields: [{ name: '_hint', label: 'è¯´æ˜', type: 'hint', text: 'å®šæ—¶è§¦å‘ä¸å“åº”ç”¨æˆ·æ¶ˆæ¯ï¼Œéœ€åœ¨ã€Œå®šæ—¶ä»»åŠ¡ã€ä¸­é…ç½®æ‰§è¡Œæ—¶é—´ã€‚æ­¤å·¥ä½œæµä»…ä¾›å®šæ—¶ä»»åŠ¡è°ƒç”¨ã€‚' }] }
    };

    // æ¡ä»¶ç±»å‹é…ç½®
    const CONDITION_TYPES = {
      contains: { label: 'å†…å®¹åŒ…å«', fields: [{ name: 'condition_value', label: 'åŒ…å«çš„æ–‡å­—', type: 'text', placeholder: 'æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦åŒ…å«æ­¤æ–‡å­—' }] },
      equals: { label: 'å†…å®¹ç­‰äº', fields: [{ name: 'condition_value', label: 'ç­‰äºçš„æ–‡å­—', type: 'text', placeholder: 'æ¶ˆæ¯å†…å®¹å®Œå…¨ç­‰äºæ­¤æ–‡å­—' }] },
      regex: { label: 'æ­£åˆ™åŒ¹é…', fields: [{ name: 'condition_value', label: 'æ­£åˆ™è¡¨è¾¾å¼', type: 'text', placeholder: 'å¦‚ ^hello.*world$' }] },
      random: { label: 'éšæœºæ¦‚ç‡', fields: [{ name: 'condition_value', label: 'æ¦‚ç‡(%)', type: 'number', placeholder: '0-100ï¼Œå¦‚ 50 è¡¨ç¤º50%æ¦‚ç‡' }] },
      user_id: { label: 'ç”¨æˆ·ID', fields: [{ name: 'condition_value', label: 'ç”¨æˆ·ID', type: 'text', placeholder: 'æŒ‡å®šç”¨æˆ·IDæ‰é€šè¿‡' }] },
      group_id: { label: 'ç¾¤ID', fields: [{ name: 'condition_value', label: 'ç¾¤ID', type: 'text', placeholder: 'æŒ‡å®šç¾¤IDæ‰é€šè¿‡' }] },
      var_equals: { label: 'å˜é‡ç­‰äº', fields: [{ name: 'var_name', label: 'å˜é‡å', type: 'text', placeholder: 'è¦æ£€æŸ¥çš„å˜é‡å' }, { name: 'condition_value', label: 'ç­‰äºçš„å€¼', type: 'text', placeholder: 'å˜é‡åº”ç­‰äºçš„å€¼' }] },
      var_gt: { label: 'å˜é‡å¤§äº', fields: [{ name: 'var_name', label: 'å˜é‡å', type: 'text', placeholder: 'è¦æ£€æŸ¥çš„å˜é‡å' }, { name: 'condition_value', label: 'å¤§äºçš„å€¼', type: 'number', placeholder: 'å˜é‡åº”å¤§äºçš„æ•°å€¼' }] },
      var_lt: { label: 'å˜é‡å°äº', fields: [{ name: 'var_name', label: 'å˜é‡å', type: 'text', placeholder: 'è¦æ£€æŸ¥çš„å˜é‡å' }, { name: 'condition_value', label: 'å°äºçš„å€¼', type: 'number', placeholder: 'å˜é‡åº”å°äºçš„æ•°å€¼' }] },
      data_equals: { label: 'å­˜å‚¨ç­‰äº', fields: [{ name: 'condition_value', label: 'é”®å=å€¼', type: 'text', placeholder: 'å¦‚ score=100ï¼Œæ£€æŸ¥ç”¨æˆ·å­˜å‚¨' }] },
      data_gt: { label: 'å­˜å‚¨å¤§äº', fields: [{ name: 'condition_value', label: 'é”®å>å€¼', type: 'text', placeholder: 'å¦‚ score>50ï¼Œæ£€æŸ¥ç”¨æˆ·å­˜å‚¨' }] },
      data_lt: { label: 'å­˜å‚¨å°äº', fields: [{ name: 'condition_value', label: 'é”®å<å€¼', type: 'text', placeholder: 'å¦‚ score<100ï¼Œæ£€æŸ¥ç”¨æˆ·å­˜å‚¨' }] },
      data_is_today: { label: 'ä»Šæ—¥å·²æ“ä½œ', fields: [{ name: 'condition_value', label: 'å­˜å‚¨é”®å', type: 'text', placeholder: 'å­˜å‚¨æ—¥æœŸçš„é”®åï¼Œå¦‚ last_sign' }] },
      cooldown: { label: 'å†·å´æ—¶é—´', fields: [{ name: 'condition_value', label: 'é”®å,ç§’æ•°', type: 'text', placeholder: 'å¦‚ last_use,60 è¡¨ç¤º60ç§’å†·å´' }] },
      time_range: { label: 'æ—¶é—´èŒƒå›´', fields: [{ name: 'condition_value', label: 'å¼€å§‹-ç»“æŸ(å°æ—¶)', type: 'text', placeholder: 'å¦‚ 9-18 è¡¨ç¤º9ç‚¹åˆ°18ç‚¹' }] },
      weekday_in: { label: 'æ˜ŸæœŸå‡ ', fields: [{ name: 'condition_value', label: 'æ˜ŸæœŸ', type: 'text', placeholder: 'å¦‚ å‘¨ä¸€|å‘¨äºŒ|å‘¨ä¸‰ æˆ– 1|2|3' }] },
      global_equals: { label: 'å…¨å±€å­˜å‚¨ç­‰äº', fields: [{ name: 'condition_value', label: 'é”®å=å€¼', type: 'text', placeholder: 'å¦‚ status=open' }] },
      global_gt: { label: 'å…¨å±€å­˜å‚¨å¤§äº', fields: [{ name: 'condition_value', label: 'é”®å>å€¼', type: 'text', placeholder: 'å¦‚ count>10' }] },
      expression: { label: 'è¡¨è¾¾å¼', fields: [{ name: 'condition_value', label: 'JSè¡¨è¾¾å¼', type: 'textarea', placeholder: 'å¦‚ {score} > 50 && {level} >= 2' }] }
    };

    // åŠ¨ä½œç±»å‹é…ç½®
    const ACTION_TYPES = {
      reply_text: { label: 'å›å¤æ–‡å­—', fields: [{ name: 'action_value', label: 'å›å¤å†…å®¹', type: 'textarea', placeholder: 'æ”¯æŒå˜é‡ {user_id} {$1}ï¼Œç”¨|||åˆ†éš”å¤šæ¡éšæœºå›å¤', hasHelp: true }] },
      reply_image: { label: 'å‘é€å›¾ç‰‡', fields: [{ name: 'action_value', label: 'å›¾ç‰‡URL', type: 'text', placeholder: 'http://... æˆ– base64://...' }, { name: 'image_text', label: 'å›¾ç‰‡è¯´æ˜', type: 'text', placeholder: 'å¯é€‰' }] },
      reply_voice: { label: 'å‘é€è¯­éŸ³', fields: [{ name: 'action_value', label: 'è¯­éŸ³URL', type: 'text', placeholder: 'http://... æˆ– base64://...' }] },
      reply_video: { label: 'å‘é€è§†é¢‘', fields: [{ name: 'action_value', label: 'è§†é¢‘URL', type: 'text', placeholder: 'http://... æˆ– base64://...' }] },
      reply_at: { label: '@å›å¤', fields: [{ name: 'action_value', label: 'å›å¤å†…å®¹', type: 'textarea', placeholder: '@ç”¨æˆ·åçš„æ¶ˆæ¯å†…å®¹' }] },
      reply_face: { label: 'å‘é€è¡¨æƒ…', fields: [{ name: 'action_value', label: 'è¡¨æƒ…ID', type: 'number', placeholder: 'QQè¡¨æƒ…ID' }] },
      reply_poke: { label: 'æˆ³ä¸€æˆ³', fields: [{ name: 'action_value', label: 'ç›®æ ‡ç”¨æˆ·', type: 'text', placeholder: 'ç•™ç©ºåˆ™æˆ³å‘é€è€…' }] },
      reply_forward: { label: 'åˆå¹¶è½¬å‘', fields: [{ name: 'action_value', label: 'æ¶ˆæ¯åˆ—è¡¨', type: 'textarea', placeholder: 'ç”¨|||åˆ†éš”å¤šæ¡æ¶ˆæ¯' }] },
      reply_json: { label: 'JSONå¡ç‰‡', fields: [{ name: 'action_value', label: 'JSONå†…å®¹', type: 'textarea', placeholder: 'å¡ç‰‡JSONæ•°æ®' }] },
      reply_file: { label: 'å‘é€æ–‡ä»¶', fields: [{ name: 'action_value', label: 'æ–‡ä»¶URL', type: 'text', placeholder: 'æ–‡ä»¶åœ°å€' }, { name: 'file_name', label: 'æ–‡ä»¶å', type: 'text', placeholder: 'å¯é€‰' }] },
      reply_music: { label: 'éŸ³ä¹åˆ†äº«', fields: [{ name: 'music_type', label: 'å¹³å°', type: 'select', options: [{ value: 'qq', label: 'QQéŸ³ä¹' }, { value: '163', label: 'ç½‘æ˜“äº‘' }, { value: 'custom', label: 'è‡ªå®šä¹‰' }] }, { name: 'action_value', label: 'éŸ³ä¹ID', type: 'text', placeholder: 'æ­Œæ›²ID' }] },
      custom_api: { label: 'è°ƒç”¨å¤–éƒ¨API', fields: [{ name: 'api_url', label: 'APIåœ°å€', type: 'text', placeholder: 'https://api.example.com/...' }, { name: 'api_method', label: 'è¯·æ±‚æ–¹å¼', type: 'select', options: [{ value: 'GET', label: 'GET' }, { value: 'POST', label: 'POST' }] }, { name: 'api_headers', label: 'è¯·æ±‚å¤´', type: 'textarea', placeholder: 'JSONæ ¼å¼æˆ–key:valueæ¯è¡Œä¸€ä¸ª' }, { name: 'api_body', label: 'è¯·æ±‚ä½“', type: 'textarea', placeholder: 'POSTè¯·æ±‚çš„body' }, { name: 'response_type', label: 'å“åº”ç±»å‹', type: 'select', options: [{ value: 'json', label: 'JSON' }, { value: 'text', label: 'æ–‡æœ¬' }] }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text', placeholder: 'api_result' }, { name: 'api_reply', label: 'è‡ªåŠ¨å›å¤', type: 'textarea', placeholder: 'å¯ç”¨{api_result}æˆ–{api_json.field}' }] },
      math: { label: 'æ•°å­¦è¿ç®—', fields: [{ name: 'math_type', label: 'è¿ç®—ç±»å‹', type: 'select', options: [{ value: 'add', label: 'åŠ æ³•' }, { value: 'sub', label: 'å‡æ³•' }, { value: 'mul', label: 'ä¹˜æ³•' }, { value: 'div', label: 'é™¤æ³•' }, { value: 'mod', label: 'å–ä½™' }, { value: 'random', label: 'éšæœºæ•°' }] }, { name: 'operand1', label: 'æ“ä½œæ•°1', type: 'text', placeholder: 'æ•°å­—æˆ–å˜é‡' }, { name: 'operand2', label: 'æ“ä½œæ•°2', type: 'text', placeholder: 'æ•°å­—æˆ–å˜é‡' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text', placeholder: 'math_result' }] },
      string_op: { label: 'å­—ç¬¦ä¸²æ“ä½œ', fields: [{ name: 'string_type', label: 'æ“ä½œç±»å‹', type: 'select', options: [{ value: 'concat', label: 'æ‹¼æ¥' }, { value: 'replace', label: 'æ›¿æ¢' }, { value: 'split', label: 'åˆ†å‰²' }, { value: 'substr', label: 'æˆªå–' }, { value: 'length', label: 'é•¿åº¦' }, { value: 'upper', label: 'å¤§å†™' }, { value: 'lower', label: 'å°å†™' }] }, { name: 'input1', label: 'è¾“å…¥1', type: 'text' }, { name: 'input2', label: 'è¾“å…¥2', type: 'text' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text', placeholder: 'string_result' }] },
      group_sign: { label: 'ç¾¤ç­¾åˆ°', fields: [{ name: '_hint', label: 'è¯´æ˜', type: 'hint', text: 'è‡ªåŠ¨ä¸ºå½“å‰ç¾¤æ‰§è¡Œç­¾åˆ°ï¼Œæ— éœ€é¢å¤–å‚æ•°' }] },
      group_ban: { label: 'ç¾¤ç¦è¨€', fields: [{ name: 'target_user', label: 'ç›®æ ‡ç”¨æˆ·', type: 'text', placeholder: 'ç•™ç©ºåˆ™ä¸ºå‘é€è€… {user_id}' }, { name: 'ban_duration', label: 'ç¦è¨€æ—¶é•¿(ç§’)', type: 'number', placeholder: '0=è§£é™¤ç¦è¨€ï¼Œé»˜è®¤600' }] },
      group_kick: { label: 'ç¾¤è¸¢äºº', fields: [{ name: 'target_user', label: 'ç›®æ ‡ç”¨æˆ·', type: 'text', placeholder: 'ç•™ç©ºåˆ™ä¸ºå‘é€è€… {user_id}' }, { name: 'reject_add', label: 'æ‹’ç»å†æ¬¡åŠ ç¾¤', type: 'select', options: [{ value: 'false', label: 'å¦' }, { value: 'true', label: 'æ˜¯' }] }] },
      group_whole_ban: { label: 'å…¨å‘˜ç¦è¨€', fields: [{ name: 'enable_ban', label: 'å¼€å…³', type: 'select', options: [{ value: 'true', label: 'å¼€å¯ç¦è¨€' }, { value: 'false', label: 'å…³é—­ç¦è¨€' }] }] },
      group_set_card: { label: 'è®¾ç½®ç¾¤åç‰‡', fields: [{ name: 'target_user', label: 'ç›®æ ‡ç”¨æˆ·', type: 'text', placeholder: 'ç•™ç©ºåˆ™ä¸ºå‘é€è€… {user_id}' }, { name: 'card_value', label: 'ç¾¤åç‰‡', type: 'text', placeholder: 'æ–°çš„ç¾¤åç‰‡' }] },
      group_notice: { label: 'å‘ç¾¤å…¬å‘Š', fields: [{ name: 'action_value', label: 'å…¬å‘Šå†…å®¹', type: 'textarea', placeholder: 'å…¬å‘Šæ–‡æœ¬' }] },
      recall_msg: { label: 'æ’¤å›æ¶ˆæ¯', fields: [{ name: 'message_id', label: 'æ¶ˆæ¯ID', type: 'text', placeholder: 'ç•™ç©ºæ’¤å›è§¦å‘æ¶ˆæ¯ {message_id}' }] },
      call_api: { label: 'è°ƒç”¨NapCat API', fields: [{ name: 'api_action', label: 'APIåç§°', type: 'text', placeholder: 'å¦‚ send_group_sign' }, { name: 'api_params', label: 'å‚æ•°(JSON)', type: 'textarea', placeholder: '{"group_id":"{group_id}"}' }, { name: 'result_var', label: 'ç»“æœå˜é‡', type: 'text', placeholder: 'å¯é€‰' }] }
    };

    // çŠ¶æ€å˜é‡
    let currentWorkflow = null;
    let workflows = [];
    let selectedNode = null;
    let editingNode = null;
    let connectingFrom = null;
    let nodeIdCounter = 1;


    // Toast
    function showToast (msg, type = 'success') {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${msg}`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    // æ¨¡æ€æ¡†
    function openModal (id) { document.getElementById(id).classList.add('show'); }
    function closeModal (id) { document.getElementById(id).classList.remove('show'); }

    // æ˜¾ç¤ºå›å¤å˜é‡å¸®åŠ©
    function showReplyHelp () { openModal('replyHelpModal'); }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      initCanvas();
      loadWorkflows();
    });

    function initCanvas () {
      const canvas = document.getElementById('canvasInner');
      document.querySelectorAll('.node-item').forEach(item => {
        item.addEventListener('dragstart', e => e.dataTransfer.setData('nodeType', item.dataset.type));
      });
      canvas.addEventListener('dragover', e => e.preventDefault());
      canvas.addEventListener('drop', e => {
        e.preventDefault();
        const type = e.dataTransfer.getData('nodeType');
        if (type && NODE_CONFIGS[type]) {
          const rect = canvas.getBoundingClientRect();
          const container = document.getElementById('canvasContainer');
          createNode(type, e.clientX - rect.left + container.scrollLeft, e.clientY - rect.top + container.scrollTop);
        }
      });
      canvas.addEventListener('click', e => { if (e.target === canvas) { if (selectedNode) { selectedNode.classList.remove('selected'); selectedNode = null; } } });
    }

    function createNode (type, x, y, data = {}, id = null) {
      const cfg = NODE_CONFIGS[type];
      if (!cfg) return null;
      const node = document.createElement('div');
      node.className = `wf-node ${type}`;
      node.id = id || `node_${nodeIdCounter++}`;
      node.style.left = x + 'px';
      node.style.top = y + 'px';
      node.dataset.type = type;
      node.dataset.data = JSON.stringify(data);

      let preview = '';
      if (type === 'trigger') preview = data.trigger_content || '(æœªè®¾ç½®)';
      else if (type === 'condition') preview = data.condition_value || '(æœªè®¾ç½®)';
      else if (type === 'action') preview = data.action_value?.substring(0, 20) || data.action_type || '(æœªè®¾ç½®)';
      else if (type === 'comment') preview = data.comment_text?.substring(0, 20) || '...';

      node.innerHTML = `
    <button class="btn-del-node" onclick="deleteNode('${node.id}')">&times;</button>
    <div class="node-header"><i class="bi ${cfg.icon}"></i> ${cfg.title}</div>
    <div class="node-body">${preview}</div>
    ${cfg.inputs > 0 ? '<div class="node-port input"></div>' : ''}
    ${cfg.outputs === 1 ? '<div class="node-port output"></div>' : ''}
    ${cfg.outputs === 2 ? '<div class="node-port output output-1"></div><div class="node-port output output-2"></div>' : ''}
  `;

      // æ‹–æ‹½
      let isDragging = false, startX, startY, nodeStartX, nodeStartY;
      node.addEventListener('mousedown', e => {
        if (e.target.classList.contains('node-port') || e.target.classList.contains('btn-del-node')) return;
        isDragging = true;
        startX = e.clientX; startY = e.clientY;
        nodeStartX = parseInt(node.style.left); nodeStartY = parseInt(node.style.top);
        if (selectedNode) selectedNode.classList.remove('selected');
        selectedNode = node;
        node.classList.add('selected');
      });
      document.addEventListener('mousemove', e => {
        if (!isDragging) return;
        node.style.left = (nodeStartX + e.clientX - startX) + 'px';
        node.style.top = (nodeStartY + e.clientY - startY) + 'px';
        renderConnections();
      });
      document.addEventListener('mouseup', () => { isDragging = false; });

      // åŒå‡»ç¼–è¾‘
      node.addEventListener('dblclick', () => editNode(node));

      // è¾“å‡ºç«¯å£ç‚¹å‡»
      node.querySelectorAll('.node-port.output, .node-port.output-1, .node-port.output-2').forEach(port => {
        port.addEventListener('click', e => {
          e.stopPropagation();
          e.preventDefault();
          if (connectingFrom) {
            document.querySelectorAll('.node-port.waiting').forEach(p => p.classList.remove('waiting'));
            connectingFrom = null;
          } else {
            connectingFrom = { nodeId: node.id, output: port.classList.contains('output-1') ? 'output-1' : port.classList.contains('output-2') ? 'output-2' : 'output_1' };
            port.classList.add('waiting');
            showToast('ç‚¹å‡»ç›®æ ‡èŠ‚ç‚¹çš„è¾“å…¥ç«¯å£å®Œæˆè¿æ¥');
          }
        });
      });

      // è¾“å…¥ç«¯å£ç‚¹å‡»
      const inputPort = node.querySelector('.node-port.input');
      if (inputPort) {
        inputPort.addEventListener('click', e => {
          e.stopPropagation();
          e.preventDefault();
          if (connectingFrom && connectingFrom.nodeId !== node.id) {
            addConnection(connectingFrom.nodeId, connectingFrom.output, node.id);
            document.querySelectorAll('.node-port.waiting').forEach(p => p.classList.remove('waiting'));
            connectingFrom = null;
            showToast('è¿æ¥æˆåŠŸ');
          } else if (!connectingFrom) {
            showToast('è¯·å…ˆç‚¹å‡»è¾“å‡ºç«¯å£');
          }
        });
      }

      document.getElementById('canvasInner').appendChild(node);
      return node;
    }

    function deleteNode (nodeId) {
      const node = document.getElementById(nodeId);
      if (node) {
        node.remove();
        // åŒæ­¥åˆ é™¤å…¨å±€connectionsä¸­ä¸è¯¥èŠ‚ç‚¹ç›¸å…³çš„è¿æ¥
        connections = connections.filter(c => c.from_node !== nodeId && c.to_node !== nodeId);
        if (currentWorkflow) {
          currentWorkflow.nodes = currentWorkflow.nodes.filter(n => n.id !== nodeId);
          currentWorkflow.connections = currentWorkflow.connections.filter(c => c.from_node !== nodeId && c.to_node !== nodeId);
        }
        renderConnections();
      }
    }

    function editNode (node) {
      editingNode = node;
      const type = node.dataset.type;
      const cfg = NODE_CONFIGS[type];
      const data = JSON.parse(node.dataset.data || '{}');

      document.getElementById('nodeModalTitle').textContent = `ç¼–è¾‘ ${cfg.title}`;

      // åŠ¨æ€é…ç½®èŠ‚ç‚¹
      if (type === 'action') {
        renderActionEditor(data);
      } else if (type === 'condition') {
        renderConditionEditor(data);
      } else if (type === 'trigger') {
        renderTriggerEditor(data);
      } else {
        let html = '';
        (cfg.fields || []).forEach(f => {
          html += renderField(f, data[f.name]);
        });
        html += `<div class="ai-input-wrap"><input type="text" class="form-control" id="aiNodeDesc" placeholder="ç”¨AIæè¿°è¿™ä¸ªèŠ‚ç‚¹..."><button class="btn btn-sm" onclick="aiGenerateNode('${type}')"><i class="bi bi-stars"></i></button></div>`;
        document.getElementById('nodeModalBody').innerHTML = html;
      }
      openModal('nodeModal');
    }

    // æ¸²æŸ“å•ä¸ªå­—æ®µ
    function renderField (f, val) {
      val = val !== undefined ? val : (f.default || '');
      // å¸®åŠ©æŒ‰é’®
      const helpBtn = f.hasHelp ? `<button type="button" class="btn btn-sm" onclick="showReplyHelp()" style="margin-left:8px;padding:2px 8px;font-size:10px" title="æŸ¥çœ‹æ”¯æŒçš„å˜é‡"><i class="bi bi-question-circle"></i> å˜é‡è¯´æ˜</button>` : '';
      if (f.type === 'hint') {
        return `<div class="form-group" style="background:var(--accent-light);padding:10px;border-radius:6px;font-size:11px;color:var(--text-secondary)"><i class="bi bi-info-circle"></i> ${f.text}</div>`;
      } else if (f.type === 'select') {
        return `<div class="form-group"><label class="form-label">${f.label}${helpBtn}</label><select class="form-control" data-field="${f.name}">${f.options.map(o => `<option value="${o.value}" ${val == o.value ? 'selected' : ''}>${o.label}</option>`).join('')}</select></div>`;
      } else if (f.type === 'textarea') {
        return `<div class="form-group"><label class="form-label" style="display:flex;align-items:center;justify-content:space-between">${f.label}${helpBtn}</label><textarea class="form-control" data-field="${f.name}" placeholder="${f.placeholder || ''}">${val}</textarea></div>`;
      } else {
        return `<div class="form-group"><label class="form-label">${f.label}${helpBtn}</label><input type="${f.type || 'text'}" class="form-control" data-field="${f.name}" value="${val}" placeholder="${f.placeholder || ''}"></div>`;
      }
    }

    // æ¸²æŸ“è§¦å‘å™¨ç¼–è¾‘å™¨
    function renderTriggerEditor (data) {
      const currentType = data.trigger_type || 'exact';
      let html = `<div class="form-group"><label class="form-label">è§¦å‘ç±»å‹</label><select class="form-control" data-field="trigger_type" onchange="onTriggerTypeChange(this.value)">`;
      Object.entries(TRIGGER_TYPES).forEach(([k, v]) => {
        html += `<option value="${k}" ${currentType === k ? 'selected' : ''}>${v.label}</option>`;
      });
      html += `</select></div><div id="triggerFieldsContainer"></div>`;
      html += `<div class="ai-input-wrap"><input type="text" class="form-control" id="aiNodeDesc" placeholder="ç”¨AIæè¿°è¿™ä¸ªè§¦å‘å™¨..."><button class="btn btn-sm" onclick="aiGenerateNode('trigger')"><i class="bi bi-stars"></i></button></div>`;
      document.getElementById('nodeModalBody').innerHTML = html;
      renderTriggerFields(currentType, data);
    }

    // è§¦å‘å™¨ç±»å‹åˆ‡æ¢
    function onTriggerTypeChange (triggerType) {
      const data = {};
      document.querySelectorAll('#nodeModalBody [data-field]').forEach(el => {
        data[el.dataset.field] = el.value;
      });
      data.trigger_type = triggerType;
      renderTriggerFields(triggerType, data);
    }

    // æ¸²æŸ“è§¦å‘å™¨ä¸“ç”¨å­—æ®µ
    function renderTriggerFields (triggerType, data) {
      const cfg = TRIGGER_TYPES[triggerType];
      if (!cfg) return;
      let html = '';
      (cfg.fields || []).forEach(f => {
        html += renderField(f, data[f.name]);
      });
      document.getElementById('triggerFieldsContainer').innerHTML = html;
    }

    // æ¸²æŸ“æ¡ä»¶ç¼–è¾‘å™¨
    function renderConditionEditor (data) {
      const currentType = data.condition_type || 'contains';
      let html = `<div class="form-group"><label class="form-label">æ¡ä»¶ç±»å‹</label><select class="form-control" data-field="condition_type" onchange="onConditionTypeChange(this.value)">`;
      Object.entries(CONDITION_TYPES).forEach(([k, v]) => {
        html += `<option value="${k}" ${currentType === k ? 'selected' : ''}>${v.label}</option>`;
      });
      html += `</select></div><div id="conditionFieldsContainer"></div>`;
      html += `<div style="margin-top:10px;padding:10px;background:var(--accent-light);border-radius:6px;font-size:11px"><i class="bi bi-info-circle"></i> æ¡ä»¶æˆç«‹èµ°<span style="color:var(--success-color)">ç»¿è‰²è¾“å‡º</span>ï¼Œä¸æˆç«‹èµ°<span style="color:var(--danger-color)">çº¢è‰²è¾“å‡º</span></div>`;
      html += `<div class="ai-input-wrap"><input type="text" class="form-control" id="aiNodeDesc" placeholder="ç”¨AIæè¿°è¿™ä¸ªæ¡ä»¶..."><button class="btn btn-sm" onclick="aiGenerateNode('condition')"><i class="bi bi-stars"></i></button></div>`;
      document.getElementById('nodeModalBody').innerHTML = html;
      renderConditionFields(currentType, data);
    }

    // æ¡ä»¶ç±»å‹åˆ‡æ¢
    function onConditionTypeChange (conditionType) {
      const data = {};
      document.querySelectorAll('#nodeModalBody [data-field]').forEach(el => {
        data[el.dataset.field] = el.value;
      });
      data.condition_type = conditionType;
      renderConditionFields(conditionType, data);
    }

    // æ¸²æŸ“æ¡ä»¶ä¸“ç”¨å­—æ®µ
    function renderConditionFields (conditionType, data) {
      const cfg = CONDITION_TYPES[conditionType];
      if (!cfg) return;
      let html = '';
      (cfg.fields || []).forEach(f => {
        html += renderField(f, data[f.name]);
      });
      document.getElementById('conditionFieldsContainer').innerHTML = html;
    }

    // æ¸²æŸ“åŠ¨ä½œç¼–è¾‘å™¨
    function renderActionEditor (data) {
      const currentType = data.action_type || 'reply_text';
      let html = `<div class="form-group"><label class="form-label">åŠ¨ä½œç±»å‹</label><select class="form-control" data-field="action_type" onchange="onActionTypeChange(this.value)">`;
      Object.entries(ACTION_TYPES).forEach(([k, v]) => {
        html += `<option value="${k}" ${currentType === k ? 'selected' : ''}>${v.label}</option>`;
      });
      html += `</select></div><div id="actionFieldsContainer"></div>`;
      html += `<div class="ai-input-wrap"><input type="text" class="form-control" id="aiNodeDesc" placeholder="ç”¨AIæè¿°è¿™ä¸ªåŠ¨ä½œ..."><button class="btn btn-sm" onclick="aiGenerateNode('action')"><i class="bi bi-stars"></i></button></div>`;
      document.getElementById('nodeModalBody').innerHTML = html;
      renderActionFields(currentType, data);
    }

    // åŠ¨ä½œç±»å‹åˆ‡æ¢
    function onActionTypeChange (actionType) {
      const data = {};
      document.querySelectorAll('#nodeModalBody [data-field]').forEach(el => {
        data[el.dataset.field] = el.value;
      });
      data.action_type = actionType;
      renderActionFields(actionType, data);
    }

    // æ¸²æŸ“åŠ¨ä½œä¸“ç”¨å­—æ®µ
    function renderActionFields (actionType, data) {
      const cfg = ACTION_TYPES[actionType];
      if (!cfg) return;
      let html = '';
      (cfg.fields || []).forEach(f => {
        html += renderField(f, data[f.name]);
      });
      document.getElementById('actionFieldsContainer').innerHTML = html;
    }

    function saveNodeEdit () {
      if (!editingNode) return;
      const data = {};
      document.querySelectorAll('#nodeModalBody [data-field]').forEach(el => {
        if (el.value !== '') data[el.dataset.field] = el.value;
      });
      editingNode.dataset.data = JSON.stringify(data);

      const type = editingNode.dataset.type;
      let preview = '';
      if (type === 'trigger') preview = data.trigger_content || '(æœªè®¾ç½®)';
      else if (type === 'condition') {
        const condCfg = CONDITION_TYPES[data.condition_type];
        preview = condCfg?.label || data.condition_type || '(æœªè®¾ç½®)';
        if (data.condition_value) preview += ': ' + data.condition_value.substring(0, 12);
      }
      else if (type === 'action') {
        const actionCfg = ACTION_TYPES[data.action_type];
        preview = actionCfg?.label || data.action_type || '(æœªè®¾ç½®)';
        if (data.action_value) preview += ': ' + data.action_value.substring(0, 15);
      }
      else if (type === 'comment') preview = data.comment_text?.substring(0, 20) || '...';
      else preview = Object.values(data)[0]?.toString().substring(0, 20) || '...';
      editingNode.querySelector('.node-body').textContent = preview;

      closeModal('nodeModal');
      editingNode = null;
    }

    // AI ç”ŸæˆèŠ‚ç‚¹
    async function aiGenerateNode (type) {
      const desc = document.getElementById('aiNodeDesc').value.trim();
      if (!desc) { showToast('è¯·è¾“å…¥æè¿°', 'error'); return; }
      const cfg = NODE_CONFIGS[type];
      let fields = '';
      if (type === 'action') {
        const actionType = document.querySelector('[data-field="action_type"]')?.value || 'reply_text';
        const actionCfg = ACTION_TYPES[actionType];
        fields = 'action_type, ' + (actionCfg?.fields?.map(f => f.name).join(', ') || '');
      } else if (type === 'condition') {
        const conditionType = document.querySelector('[data-field="condition_type"]')?.value || 'contains';
        const condCfg = CONDITION_TYPES[conditionType];
        fields = 'condition_type, ' + (condCfg?.fields?.map(f => f.name).join(', ') || '');
      } else {
        fields = cfg?.fields?.map(f => f.name).join(', ') || '';
      }
      const prompt = `ç”Ÿæˆ${cfg?.title || type}èŠ‚ç‚¹çš„JSONé…ç½®ã€‚å¯ç”¨å­—æ®µ: ${fields}ã€‚éœ€æ±‚: ${desc}ã€‚åªè¿”å›JSONå¯¹è±¡ï¼Œå¦‚ {"trigger_type":"exact","trigger_content":"ç­¾åˆ°"}`;

      try {
        const res = await fetch(AI_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'gpt-5', type: 1, bot_id: 'webui', user_id: 'webui', messages: [{ role: 'user', content: prompt }] })
        });
        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || '';
        const match = content.match(/\{[\s\S]*\}/);
        if (match) {
          const nodeData = JSON.parse(match[0]);
          Object.entries(nodeData).forEach(([k, v]) => {
            const el = document.querySelector(`#nodeModalBody [data-field="${k}"]`);
            if (el) el.value = v;
          });
          showToast('AIå·²å¡«å……', 'success');
        } else {
          showToast('è§£æå¤±è´¥', 'error');
        }
      } catch (e) { showToast('è¯·æ±‚å¤±è´¥', 'error'); }
    }

    // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†ï¼ˆæ›¿ä»£åŸç”Ÿconfirmï¼Œæ²™ç›’ç¯å¢ƒä¸‹å¯ç”¨ï¼‰
    let confirmCallback = null;
    function showConfirm (message, callback) {
      document.getElementById('confirmModalMessage').textContent = message;
      confirmCallback = callback;
      openModal('confirmModal');
    }
    function closeConfirmModal (confirmed) {
      closeModal('confirmModal');
      if (confirmCallback) { confirmCallback(confirmed); confirmCallback = null; }
    }

    // è¿æ¥
    let connections = [];

    // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å­˜åœ¨
    function connectionExists (fromNode, fromOutput, toNode) {
      return connections.some(c => c.from_node === fromNode && c.from_output === fromOutput && c.to_node === toNode);
    }

    // åˆ é™¤æŒ‡å®šè¿æ¥
    function removeConnection (fromNode, fromOutput, toNode) {
      connections = connections.filter(c => !(c.from_node === fromNode && c.from_output === fromOutput && c.to_node === toNode));
      if (currentWorkflow) {
        currentWorkflow.connections = currentWorkflow.connections.filter(c => !(c.from_node === fromNode && c.from_output === fromOutput && c.to_node === toNode));
      }
      renderConnections();
    }

    function addConnection (fromNode, fromOutput, toNode) {
      // æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œå·²å­˜åœ¨åˆ™åˆ é™¤ï¼ˆå–æ¶ˆè¿æ¥ï¼‰
      if (connectionExists(fromNode, fromOutput, toNode)) {
        removeConnection(fromNode, fromOutput, toNode);
        showToast('å·²å–æ¶ˆè¿æ¥');
        return;
      }
      const conn = { from_node: fromNode, from_output: fromOutput, to_node: toNode };
      connections.push(conn);
      if (currentWorkflow) {
        if (!currentWorkflow.connections) currentWorkflow.connections = [];
        currentWorkflow.connections.push(conn);
      }
      renderConnections();
    }

    function renderConnections () {
      const svg = document.getElementById('connectionsSvg');
      svg.innerHTML = '';
      const allConnections = currentWorkflow ? currentWorkflow.connections : connections;
      allConnections.forEach(c => {
        const fromEl = document.getElementById(c.from_node);
        const toEl = document.getElementById(c.to_node);
        if (!fromEl || !toEl) return;

        let fromPort;
        if (c.from_output === 'output-1') fromPort = fromEl.querySelector('.output-1');
        else if (c.from_output === 'output-2') fromPort = fromEl.querySelector('.output-2');
        else fromPort = fromEl.querySelector('.node-port.output');
        const toPort = toEl.querySelector('.node-port.input');
        if (!fromPort || !toPort) return;

        const fromRect = fromPort.getBoundingClientRect();
        const toRect = toPort.getBoundingClientRect();
        const canvas = document.getElementById('canvasInner').getBoundingClientRect();

        const x1 = fromRect.left + fromRect.width / 2 - canvas.left;
        const y1 = fromRect.top + fromRect.height / 2 - canvas.top;
        const x2 = toRect.left + toRect.width / 2 - canvas.left;
        const y2 = toRect.top + toRect.height / 2 - canvas.top;

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const cx = (x1 + x2) / 2;
        path.setAttribute('d', `M${x1},${y1} C${cx},${y1} ${cx},${y2} ${x2},${y2}`);
        path.setAttribute('class', 'connection-line');
        svg.appendChild(path);
      });
    }

    // å·¥ä½œæµæ“ä½œ
    async function loadWorkflows () {
      try {
        const res = await authFetch(API_BASE + '/list');
        const data = await res.json();
        workflows = data.workflows || [];
        renderWorkflowList();
      } catch (e) { }
    }

    function renderWorkflowList () {
      const container = document.getElementById('workflowList');
      if (!workflows.length) { container.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:11px;padding:20px">æš‚æ— å·¥ä½œæµ</div>'; return; }
      container.innerHTML = workflows.map(w => `
    <div class="wf-item ${currentWorkflow?.id === w.id ? 'active' : ''}" onclick="loadWorkflow('${w.id}')">
      <div class="wf-name">${w.name || 'æœªå‘½å'}</div>
      <div class="wf-trigger">${w.trigger_type || ''}: ${w.trigger_content || ''}</div>
      <div class="wf-actions">
        <span class="wf-badge ${w.enabled ? 'on' : 'off'}" onclick="event.stopPropagation();toggleWorkflow('${w.id}')">${w.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span>
        <button class="btn btn-sm" onclick="event.stopPropagation();exportWorkflow('${w.id}')" style="padding:2px 6px;font-size:9px" title="å¯¼å‡º"><i class="bi bi-download"></i></button>
        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteWorkflow('${w.id}')" style="padding:2px 6px;font-size:9px">åˆ é™¤</button>
      </div>
    </div>
  `).join('');
    }

    function loadWorkflow (id) {
      const w = workflows.find(x => x.id === id);
      if (!w) return;
      currentWorkflow = JSON.parse(JSON.stringify(w));

      // æ›´æ–°åç§°è¾“å…¥æ¡†
      document.getElementById('workflowNameInput').value = w.name || '';

      // æ¸…ç©ºç”»å¸ƒ
      document.querySelectorAll('.wf-node').forEach(n => n.remove());

      // åŒæ­¥å…¨å±€connectionså˜é‡
      connections = currentWorkflow.connections ? [...currentWorkflow.connections] : [];

      // éšè—ç”»å¸ƒå ä½æç¤º
      document.getElementById('canvasPlaceholder').classList.add('hidden');

      // åˆ›å»ºèŠ‚ç‚¹
      if (w.nodes) {
        w.nodes.forEach(n => createNode(n.type, n.x || 100, n.y || 100, n.data || {}, n.id));
        nodeIdCounter = Math.max(...w.nodes.map(n => parseInt(n.id?.replace('node_', '') || 0))) + 1;
      }

      // æ¸²æŸ“è¿æ¥
      renderConnections();
      renderWorkflowList();
    }

    function newWorkflow () {
      currentWorkflow = { id: '', name: 'æ–°å·¥ä½œæµ', enabled: true, nodes: [], connections: [] };
      document.getElementById('workflowNameInput').value = 'æ–°å·¥ä½œæµ';
      document.querySelectorAll('.wf-node').forEach(n => n.remove());
      connections = [];
      document.getElementById('connectionsSvg').innerHTML = '';
      // éšè—ç”»å¸ƒå ä½æç¤º
      document.getElementById('canvasPlaceholder').classList.add('hidden');
      renderWorkflowList();
    }

    function updateWorkflowName () {
      if (!currentWorkflow) return;
      currentWorkflow.name = document.getElementById('workflowNameInput').value || 'æœªå‘½å';
    }

    async function saveWorkflow () {
      if (!currentWorkflow) { showToast('è¯·å…ˆåˆ›å»ºå·¥ä½œæµ', 'error'); return; }

      // æ”¶é›†èŠ‚ç‚¹æ•°æ®
      const nodes = [];
      let trigger = null;
      document.querySelectorAll('.wf-node').forEach(node => {
        const n = {
          id: node.id,
          type: node.dataset.type,
          x: parseInt(node.style.left),
          y: parseInt(node.style.top),
          data: JSON.parse(node.dataset.data || '{}')
        };
        nodes.push(n);
        if (n.type === 'trigger') trigger = n;
      });

      if (!trigger) { showToast('éœ€è¦è‡³å°‘ä¸€ä¸ªè§¦å‘å™¨', 'error'); return; }

      currentWorkflow.nodes = nodes;
      currentWorkflow.connections = connections;
      currentWorkflow.trigger_type = trigger.data.trigger_type || 'exact';
      currentWorkflow.trigger_content = trigger.data.trigger_content || '';

      // ä»è¾“å…¥æ¡†è·å–åç§°
      currentWorkflow.name = document.getElementById('workflowNameInput').value || 'æœªå‘½åå·¥ä½œæµ';

      // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸»äººæƒé™ï¼ˆæ­£åˆ™/æ¶ˆæ¯ç›‘æ§/å®šæ—¶è§¦å‘ï¼‰
      if (needsMasterAuth(currentWorkflow.trigger_type)) {
        showMasterAuth(saveWorkflow);
        return;
      }

      try {
        const res = await masterAuthFetch(API_BASE + '/save', { method: 'POST', body: JSON.stringify(currentWorkflow) });
        const data = await res.json();
        if (data.need_auth) { masterPassword = ''; showMasterAuth(saveWorkflow); return; }
        if (data.success) {
          showToast('ä¿å­˜æˆåŠŸ');
          if (data.data?.id) currentWorkflow.id = data.data.id;
          loadWorkflows();
        } else { showToast(data.error || 'ä¿å­˜å¤±è´¥', 'error'); }
      } catch (e) { showToast('ä¿å­˜å¤±è´¥', 'error'); }
    }

    async function toggleWorkflow (id) {
      try {
        await authFetch(API_BASE + '/toggle', { method: 'POST', body: JSON.stringify({ id }) });
        loadWorkflows();
      } catch (e) { showToast('æ“ä½œå¤±è´¥', 'error'); }
    }

    async function deleteWorkflow (id) {
      showConfirm('ç¡®å®šåˆ é™¤æ­¤å·¥ä½œæµï¼Ÿ', async (confirmed) => {
        if (!confirmed) return;
        try {
          await authFetch(API_BASE + '/delete', { method: 'POST', body: JSON.stringify({ id }) });
          if (currentWorkflow?.id === id) {
            currentWorkflow = null;
            document.querySelectorAll('.wf-node').forEach(n => n.remove());
            connections = [];
            document.getElementById('connectionsSvg').innerHTML = '';
          }
          loadWorkflows();
          showToast('å·²åˆ é™¤');
        } catch (e) { showToast('åˆ é™¤å¤±è´¥', 'error'); }
      });
    }

    // AI ç”Ÿæˆå·¥ä½œæµ
    function showAiGenerate () { openModal('aiModal'); }

    async function generateWorkflowByAi () {
      const desc = document.getElementById('aiDescription').value.trim();
      const model = document.getElementById('aiModel').value;
      if (!desc) { showToast('è¯·è¾“å…¥æè¿°', 'error'); return; }

      const btn = document.getElementById('aiGenerateBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';
      document.getElementById('aiResult').style.display = 'none';

      try {
        const res = await fetch(AI_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: model,
            type: getApiType(model),
            bot_id: 'webui',
            user_id: 'webui',
            messages: [
              { role: 'system', content: WORKFLOW_SYSTEM_PROMPT },
              { role: 'user', content: desc }
            ]
          })
        });
        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || '';

        // æå– JSON
        const match = content.match(/\{[\s\S]*\}/);
        if (match) {
          try {
            const workflow = JSON.parse(match[0]);
            document.getElementById('aiResult').style.display = 'block';
            document.getElementById('aiResult').innerHTML = `<div style="color:var(--success-color);margin-bottom:8px"><i class="bi bi-check-circle"></i> ç”ŸæˆæˆåŠŸï¼èŠ‚ç‚¹æ•°: ${workflow.nodes?.length || Object.keys(workflow.nodes || {}).length}</div><button class="btn btn-sm btn-success" onclick="applyAiWorkflow()">åº”ç”¨åˆ°ç”»å¸ƒ</button>`;
            window._aiWorkflow = workflow;
          } catch (parseErr) {
            document.getElementById('aiResult').style.display = 'block';
            document.getElementById('aiResult').innerHTML = `<div style="color:var(--danger-color)"><i class="bi bi-exclamation-circle"></i> JSONè§£æå¤±è´¥: ${parseErr.message}</div><pre style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:4px;font-size:12px;max-height:200px;overflow:auto;white-space:pre-wrap">${match[0].substring(0, 500)}</pre>`;
          }
        } else {
          document.getElementById('aiResult').style.display = 'block';
          document.getElementById('aiResult').innerHTML = `<div style="color:var(--danger-color)"><i class="bi bi-exclamation-circle"></i> æœªæ‰¾åˆ°æœ‰æ•ˆJSON</div><pre style="margin-top:8px;padding:8px;background:#f5f5f5;border-radius:4px;font-size:12px;max-height:200px;overflow:auto;white-space:pre-wrap">${content || '(ç©º)'}</pre>`;
        }
      } catch (e) {
        document.getElementById('aiResult').style.display = 'block';
        document.getElementById('aiResult').innerHTML = `<div style="color:var(--danger-color)"><i class="bi bi-exclamation-circle"></i> è¯·æ±‚å¤±è´¥: ${e.message || e}</div>`;
      }

      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-stars"></i> ç”Ÿæˆ';
    }

    function applyAiWorkflow () {
      if (!window._aiWorkflow) return;
      const w = window._aiWorkflow;

      newWorkflow();
      currentWorkflow.name = w.name || 'AIç”Ÿæˆçš„å·¥ä½œæµ';

      // è½¬æ¢èŠ‚ç‚¹æ ¼å¼ï¼ˆæ”¯æŒæ•°ç»„å’Œå¯¹è±¡ä¸¤ç§æ ¼å¼ï¼‰
      const nodes = Array.isArray(w.nodes) ? w.nodes : Object.values(w.nodes || {});
      let maxId = 0;
      nodes.forEach((n, i) => {
        const id = n.id || `node_${i + 1}`;
        const numId = parseInt(id.replace('node_', '')) || 0;
        if (numId > maxId) maxId = numId;
        createNode(n.type, n.x || 100 + i * 180, n.y || 150, n.data || {}, id);
      });
      nodeIdCounter = maxId + 1;

      // åº”ç”¨è¿æ¥
      if (w.connections) {
        connections = w.connections;
        currentWorkflow.connections = w.connections;
        renderConnections();
      }

      closeModal('aiModal');
      showToast('å·²åº”ç”¨AIç”Ÿæˆçš„å·¥ä½œæµ');
    }

    // å®šæ—¶ä»»åŠ¡
    function showScheduledTasks () { loadScheduledTasks(); openModal('scheduledModal'); }
    async function loadScheduledTasks () {
      try {
        const res = await authFetch(API_BASE + '/scheduled/list');
        const data = await res.json();
        renderScheduledTasks(data.tasks || []);
        loadWorkflowsForSelect();
      } catch (e) { }
    }
    function renderScheduledTasks (tasks) {
      const container = document.getElementById('scheduledTaskList');
      if (!tasks.length) { container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;font-size:12px">æš‚æ— å®šæ—¶ä»»åŠ¡</div>'; return; }
      container.innerHTML = `<table class="table"><thead><tr><th>ID</th><th>å·¥ä½œæµ</th><th>æ‰§è¡Œæ—¶é—´</th><th>ç›®æ ‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>${tasks.map(t => {
        const schedule = t.task_type === 'daily' ? `æ¯å¤© ${t.daily_time}` : `æ¯ ${t.interval_seconds}ç§’`;
        return `<tr><td>${t.id}</td><td>${t.workflow_id}</td><td>${schedule}</td><td>${t.target_type}:${t.target_id}</td><td><span class="wf-badge ${t.enabled ? 'on' : 'off'}">${t.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td><td><button class="btn btn-sm" onclick="toggleTask('${t.id}')">åˆ‡æ¢</button> <button class="btn btn-sm" onclick="runTaskNow('${t.id}')">æ‰§è¡Œ</button> <button class="btn btn-sm btn-danger" onclick="deleteTask('${t.id}')">åˆ é™¤</button></td></tr>`;
      }).join('')}</tbody></table>`;
    }
    function loadWorkflowsForSelect () {
      const sel = document.getElementById('taskWorkflowId');
      sel.innerHTML = workflows.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
    }
    function showAddTaskForm () { document.getElementById('addTaskForm').style.display = 'block'; }
    function hideAddTaskForm () { document.getElementById('addTaskForm').style.display = 'none'; }
    function updateTaskTypeFields () {
      const type = document.getElementById('taskType').value;
      document.getElementById('dailyTimeGroup').style.display = type === 'daily' ? 'block' : 'none';
      document.getElementById('intervalGroup').style.display = type === 'interval' ? 'block' : 'none';
    }
    async function addScheduledTask () {
      if (requireMaster && !masterPassword) { showMasterAuth(addScheduledTask); return; }
      const task = {
        id: document.getElementById('taskId').value, workflow_id: document.getElementById('taskWorkflowId').value,
        task_type: document.getElementById('taskType').value, daily_time: document.getElementById('taskDailyTime').value,
        interval_seconds: parseInt(document.getElementById('taskInterval').value) || 3600,
        target_type: document.getElementById('taskTargetType').value, target_id: document.getElementById('taskTargetId').value,
        trigger_user_id: document.getElementById('taskTriggerUserId').value || undefined,
        enabled: true, description: document.getElementById('taskDesc').value
      };
      if (!task.id || !task.target_id) { showToast('è¯·å¡«å†™å®Œæ•´', 'error'); return; }
      try {
        const res = await masterAuthFetch(API_BASE + '/scheduled/add', { method: 'POST', body: JSON.stringify(task) });
        const data = await res.json();
        if (data.need_auth) { masterPassword = ''; showMasterAuth(addScheduledTask); return; }
        if (data.success) { showToast('å·²æ·»åŠ '); hideAddTaskForm(); loadScheduledTasks(); }
        else showToast(data.error || 'æ·»åŠ å¤±è´¥', 'error');
      } catch (e) { showToast('è¯·æ±‚å¤±è´¥', 'error'); }
    }
    async function toggleTask (id) {
      if (requireMaster && !masterPassword) { showMasterAuth(() => toggleTask(id)); return; }
      const res = await masterAuthFetch(API_BASE + '/scheduled/toggle', { method: 'POST', body: JSON.stringify({ id }) });
      const data = await res.json();
      if (data.need_auth) { masterPassword = ''; showMasterAuth(() => toggleTask(id)); return; }
      loadScheduledTasks();
    }
    async function runTaskNow (id) {
      if (requireMaster && !masterPassword) { showMasterAuth(() => runTaskNow(id)); return; }
      const res = await masterAuthFetch(API_BASE + '/scheduled/run', { method: 'POST', body: JSON.stringify({ id }) });
      const data = await res.json();
      if (data.need_auth) { masterPassword = ''; showMasterAuth(() => runTaskNow(id)); return; }
      showToast(data.success ? 'å·²æ‰§è¡Œ' : (data.error || 'æ‰§è¡Œå¤±è´¥'), data.success ? 'success' : 'error');
    }
    async function deleteTask (id) {
      showConfirm('ç¡®å®šåˆ é™¤æ­¤å®šæ—¶ä»»åŠ¡ï¼Ÿ', async (confirmed) => {
        if (!confirmed) return;
        if (requireMaster && !masterPassword) { showMasterAuth(() => deleteTask(id)); return; }
        const res = await masterAuthFetch(API_BASE + '/scheduled/delete', { method: 'POST', body: JSON.stringify({ id }) });
        const data = await res.json();
        if (data.need_auth) { masterPassword = ''; showMasterAuth(() => deleteTask(id)); return; }
        loadScheduledTasks();
        showToast('å·²åˆ é™¤');
      });
    }

    // æ˜¾ç¤ºå¯¼å‡ºå¼¹çª—
    function showExportModal (title, content) {
      let modal = document.getElementById('exportModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'exportModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-box lg">
            <div class="modal-header">
              <h5 id="exportModalTitle"><i class="bi bi-download"></i> å¯¼å‡º</h5>
              <button class="modal-close" onclick="closeModal('exportModal')">&times;</button>
            </div>
            <div class="modal-body">
              <textarea id="exportModalContent" class="form-control" style="height:350px;font-family:monospace;font-size:11px" readonly></textarea>
            </div>
            <div class="modal-footer">
              <button class="btn" onclick="closeModal('exportModal')">å…³é—­</button>
              <button class="btn btn-primary" onclick="copyExport()"><i class="bi bi-clipboard"></i> å¤åˆ¶</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      document.getElementById('exportModalTitle').innerHTML = `<i class="bi bi-download"></i> ${title}`;
      document.getElementById('exportModalContent').value = content;
      modal.classList.add('show');
    }

    // å¤åˆ¶å¯¼å‡ºå†…å®¹
    async function copyExport () {
      const content = document.getElementById('exportModalContent').value;
      try {
        await navigator.clipboard.writeText(content);
        showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      } catch {
        document.getElementById('exportModalContent').select();
        document.execCommand('copy');
        showToast('å·²å¤åˆ¶', 'success');
      }
    }

    // å¯¼å‡ºå•ä¸ªå·¥ä½œæµ
    function exportWorkflow (id) {
      const w = workflows.find(x => x.id === id);
      if (!w) { showToast('å·¥ä½œæµä¸å­˜åœ¨', 'error'); return; }
      showExportModal(`å¯¼å‡º: ${w.name || w.id}`, JSON.stringify(w, null, 2));
    }

    // å¯¼å‡ºå…¨éƒ¨å·¥ä½œæµ
    function exportAllWorkflows () {
      if (!workflows.length) { showToast('æš‚æ— å·¥ä½œæµ', 'error'); return; }
      const data = { workflows, exportTime: new Date().toISOString(), version: '1.0' };
      showExportModal(`å¯¼å‡ºå…¨éƒ¨ (${workflows.length}ä¸ª)`, JSON.stringify(data, null, 2));
    }

    // è§¦å‘å¯¼å…¥æ–‡ä»¶é€‰æ‹©
    // æ˜¾ç¤ºå¯¼å…¥å¼¹çª—
    function importWorkflows () {
      let modal = document.getElementById('importModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'importModal';
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-box lg">
            <div class="modal-header">
              <h5><i class="bi bi-upload"></i> å¯¼å…¥å·¥ä½œæµ</h5>
              <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
              <p style="color:var(--text-secondary);font-size:12px;margin-bottom:8px">ç²˜è´´ JSON å†…å®¹ï¼ˆæ”¯æŒå•ä¸ªæˆ–æ‰¹é‡å¯¼å…¥ï¼‰</p>
              <textarea id="importModalContent" class="form-control" style="height:350px;font-family:monospace;font-size:11px" placeholder='{"id":"...","name":"...","nodes":[...]}'></textarea>
            </div>
            <div class="modal-footer">
              <button class="btn" onclick="closeModal('importModal')">å–æ¶ˆ</button>
              <button class="btn btn-primary" onclick="doImport()"><i class="bi bi-check"></i> å¯¼å…¥</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      document.getElementById('importModalContent').value = '';
      modal.classList.add('show');
    }

    // æ‰§è¡Œå¯¼å…¥
    async function doImport () {
      const text = document.getElementById('importModalContent').value.trim();
      if (!text) { showToast('è¯·è¾“å…¥ JSON å†…å®¹', 'error'); return; }
      try {
        const content = JSON.parse(text);
        if (content.workflows && Array.isArray(content.workflows)) {
          await importMultipleWorkflows(content.workflows);
        } else if (content.id || content.nodes) {
          await importSingleWorkflow(content);
        } else {
          showToast('æ— æ•ˆçš„å·¥ä½œæµæ ¼å¼', 'error'); return;
        }
        closeModal('importModal');
      } catch (err) {
        showToast('JSON è§£æå¤±è´¥: ' + err.message, 'error');
      }
    }

    // å¯¼å…¥å•ä¸ªå·¥ä½œæµ
    async function importSingleWorkflow (workflow) {
      // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸»äººæƒé™
      if (needsMasterAuth(workflow.trigger_type)) {
        showMasterAuth(() => importSingleWorkflow(workflow));
        return;
      }
      // ç”Ÿæˆæ–°IDé¿å…å†²çª
      workflow.id = '';
      workflow.name = (workflow.name || 'å¯¼å…¥çš„å·¥ä½œæµ') + '_å¯¼å…¥';
      try {
        const res = await masterAuthFetch(API_BASE + '/save', { method: 'POST', body: JSON.stringify(workflow) });
        const data = await res.json();
        if (data.need_auth) { masterPassword = ''; showMasterAuth(() => importSingleWorkflow(workflow)); return; }
        if (data.success) {
          showToast('å¯¼å…¥æˆåŠŸ');
          loadWorkflows();
        } else {
          showToast(data.error || 'å¯¼å…¥å¤±è´¥', 'error');
        }
      } catch (e) { showToast('å¯¼å…¥å¤±è´¥', 'error'); }
    }

    // æ‰¹é‡å¯¼å…¥å·¥ä½œæµ
    async function importMultipleWorkflows (workflowList) {
      let success = 0, failed = 0;
      for (const w of workflowList) {
        // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸»äººæƒé™
        if (needsMasterAuth(w.trigger_type) && !masterPassword) {
          showMasterAuth(() => importMultipleWorkflows(workflowList));
          return;
        }
        w.id = '';
        w.name = (w.name || 'å·¥ä½œæµ') + '_å¯¼å…¥';
        try {
          const res = await masterAuthFetch(API_BASE + '/save', { method: 'POST', body: JSON.stringify(w) });
          const data = await res.json();
          if (data.need_auth) { masterPassword = ''; showMasterAuth(() => importMultipleWorkflows(workflowList)); return; }
          if (data.success) success++;
          else failed++;
        } catch (e) { failed++; }
      }
      showToast(`å¯¼å…¥å®Œæˆ: æˆåŠŸ ${success} ä¸ª, å¤±è´¥ ${failed} ä¸ª`);
      loadWorkflows();
    }
  </script>
</body>

</html>