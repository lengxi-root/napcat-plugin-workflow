name: Build and Release

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - run: pnpm install --no-frozen-lockfile

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="v$(node -e "console.log(require('./package.json').version)")"
          fi
          CLEAN_VERSION=$(echo $VERSION | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version tag exists
        id: check_tag
        run: |
          TAG="${{ steps.version.outputs.version }}"
          git fetch --tags --force
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update package.json version
        run: npm version ${{ steps.version.outputs.clean_version }} --no-git-tag-version --allow-same-version

      - run: pnpm build

      - name: Package
        run: |
          mkdir -p release/webui
          cp index.mjs release/
          cp src/webui/workflow.html release/webui/
          node -e "
            const pkg = require('./package.json');
            delete pkg.devDependencies;
            delete pkg.scripts;
            require('fs').writeFileSync('release/package.json', JSON.stringify(pkg, null, 2));
          "
          cd release && zip -r ../napcat-plugin-workflow.zip .

      # 每次 push main 都更新 latest
      - name: Update latest release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true
          gh release delete latest --yes 2>/dev/null || true
          gh release create latest napcat-plugin-workflow.zip \
            --title "${{ steps.version.outputs.version }}" \
            --notes "自动构建 ${{ steps.version.outputs.version }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 每次 push main 都覆盖版本 tag + 正式发版
      - name: Upsert version tag
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          TAG="${{ steps.version.outputs.version }}"
          git tag -f "$TAG"
          git push origin "$TAG" --force

      - name: Collect git log
        id: gitlog
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git tag -l "v*" --sort=version:refname | grep -v "$CURRENT_TAG" | tail -1)
          if [ -z "$PREV_TAG" ]; then PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1); fi
          COMMITS=$(git log --pretty=format:'- %s (%h)' "$PREV_TAG"..HEAD 2>/dev/null || git log --pretty=format:'- %s (%h)' -10)
          echo "$COMMITS" > commits.txt
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT

      - name: Generate Release Note
        run: |
          TAG="${{ steps.gitlog.outputs.current_tag }}"
          COMMITS=$(cat commits.txt)
          echo "## $TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### 更新内容" >> CHANGELOG.md
          echo "$COMMITS" >> CHANGELOG.md

      - name: Upsert version release
        run: |
          TAG="${{ steps.version.outputs.version }}"
          gh release delete "$TAG" --yes 2>/dev/null || true
          gh release create "$TAG" napcat-plugin-workflow.zip \
            --title "Release $TAG" \
            --notes-file CHANGELOG.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 仅版本号变化时才触发索引 PR
      - name: Trigger index update
        if: steps.check_tag.outputs.exists == 'false' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-index.yml',
              ref: 'main',
              inputs: { version: '${{ steps.version.outputs.version }}' }
            })
